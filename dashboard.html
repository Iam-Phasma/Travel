<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <h1>Welcome</h1>
            <p class="welcome-message">You are logged in as a regular user.<br>You have access to view documents but not upload new ones.</p>
        <button id="logout-btn" type="button" class="logout-btn">Log Out</button>
    </header>
    <main class="shell">
        <section class="panel wide-panel" id="ta-panel">
            <div class="panel-head">
                <h2>Travel Authorities</h2>
                <span class="pill">Read only</span>
            </div>
            <div class="table-wrap">
                <table class="data-table" aria-describedby="ta-status">
                    <thead>
                        <tr>
                            <th scope="col">TA Number</th>
                            <th scope="col">Purpose</th>
                            <th scope="col">Travel Date</th>
                            <th scope="col">Travel Until</th>
                            <th scope="col">File</th>
                        </tr>
                    </thead>
                    <tbody id="ta-body">
                        <tr>
                            <td colspan="5">Loading records...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <span class="status" id="ta-status">Fetching travel authorities.</span>
        </section>
    </main>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        // Initialize Supabase
        const supabaseUrl = "https://gptfbpktebajhvwvlfkd.supabase.co";
        const supabaseKey = "sb_publishable_TVtTKkPIWDXOf1ywQTgp5w_azlcjhLb";
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Logout functionality
        document.getElementById("logout-btn").addEventListener("click", async () => {
            try {
                await supabase.auth.signOut();
                window.location.href = "index.html";
            } catch (error) {
                console.error("Logout error:", error);
                window.location.href = "index.html";
            }
        });

        const getUserRole = async (userId) => {
            try {
                const { data, error } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", userId)
                    .maybeSingle();

                if (error) {
                    throw error;
                }

                return data?.role || "user";
            } catch (error) {
                console.error("Role lookup error:", error);
                return "user";
            }
        };

        const requireUser = async () => {
            const { data: sessionData, error } = await supabase.auth.getSession();
            if (error || !sessionData?.session) {
                window.location.href = "index.html";
                return;
            }

            // Note: Access control is enforced by Supabase RLS policies.
            // Client-side checks are for UX only and should not be relied upon for security.
        };

        const taBody = document.getElementById("ta-body");
        const taStatus = document.getElementById("ta-status");

        const renderRows = (rows) => {
            if (!rows.length) {
                taBody.innerHTML = "<tr><td colspan=\"5\">No records yet.</td></tr>";
                return;
            }

            taBody.innerHTML = rows.map((row) => {
                const dateText = row.travel_date ? new Date(row.travel_date).toLocaleDateString() : "-";
                const untilText = row.travel_until ? new Date(row.travel_until).toLocaleDateString() : "-";
                const fileUrl = row.file_url || "#";
                const safeName = row.file_name || "Download";

                return `
                    <tr>
                        <td>${row.ta_number || "-"}</td>
                        <td>${row.purpose || "-"}</td>
                        <td>${dateText}</td>
                        <td>${untilText}</td>
                        <td>
                            <a class="link-btn" href="${fileUrl}" target="_blank" rel="noopener">${safeName}</a>
                        </td>
                    </tr>
                `;
            }).join("");
        };

        const loadTravelAuthorities = async () => {
            taStatus.textContent = "Fetching travel authorities.";
            try {
                const { data, error } = await supabase
                    .from("travel_authorities")
                    .select("ta_number, purpose, travel_date, travel_until, file_name, file_url, created_at")
                    .order("created_at", { ascending: false });

                if (error) {
                    throw error;
                }

                renderRows(data || []);
                taStatus.textContent = `Loaded ${data.length} record${data.length === 1 ? "" : "s"}.`;
            } catch (error) {
                console.error("Dashboard load error:", error);
                taBody.innerHTML = "<tr><td colspan=\"5\">Unable to load records.</td></tr>";
                taStatus.textContent = "Failed to load travel authorities.";
            }
        };

        const init = async () => {
            await requireUser();
            await loadTravelAuthorities();
        };

        init();
    </script>
</body>
</html>
