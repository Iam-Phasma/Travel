<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <h1>Welcome</h1>
            <p class="welcome-message">You are logged in as a regular user.<br>You have access to view documents but not upload new ones.</p>
        <button id="logout-btn" type="button" class="logout-btn">Log Out</button>
    </header>
    <main class="shell">
        <section class="panel wide-panel" id="ta-panel">
            <div class="panel-head">
                <h2>Travel Authorities</h2>
                <span class="pill">Read only</span>
            </div>
            <div class="table-wrap max-rows-10">
                <table class="data-table" aria-describedby="ta-status">
                    <thead>
                        <tr>
                            <th scope="col">View</th>
                            <th scope="col">TA Number</th>
                            <th scope="col">Purpose</th>
                            <th scope="col">Destination</th>
                            <th scope="col">Travel Date</th>
                            <th scope="col">Travel Until</th>
                            <th scope="col">File</th>
                        </tr>
                    </thead>
                    <tbody id="ta-body">
                        <tr>
                            <td colspan="7">Loading records...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="table-footer">
                <span class="status" id="ta-status">Fetching travel authorities.</span>
                <button id="ta-more" class="pagination-btn" type="button">Load more</button>
            </div>
        </section>
    </main>

    <div id="view-modal" class="modal">
        <div class="modal-content modal-form">
            <h3>Travel Authority Details</h3>
            <div class="detail-list">
                <div class="detail-row">
                    <span class="detail-label">TA Number</span>
                    <span class="detail-value" id="view-ta-number">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Purpose</span>
                    <span class="detail-value" id="view-purpose">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Destination</span>
                    <span class="detail-value" id="view-destination">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Travel Date</span>
                    <span class="detail-value" id="view-travel-date">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Travel Until</span>
                    <span class="detail-value" id="view-travel-until">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">File</span>
                    <a class="link-btn" id="view-file-link" href="#" target="_blank" rel="noopener">Open file</a>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="close-view">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        // Initialize Supabase
        const supabaseUrl = "https://gptfbpktebajhvwvlfkd.supabase.co";
        const supabaseKey = "sb_publishable_TVtTKkPIWDXOf1ywQTgp5w_azlcjhLb";
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Logout functionality
        document.getElementById("logout-btn").addEventListener("click", async () => {
            try {
                await supabase.auth.signOut();
                window.location.href = "index.html";
            } catch (error) {
                console.error("Logout error:", error);
                window.location.href = "index.html";
            }
        });

        const getUserRole = async (userId) => {
            try {
                const { data, error } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", userId)
                    .maybeSingle();

                if (error) {
                    throw error;
                }

                return data?.role || "user";
            } catch (error) {
                console.error("Role lookup error:", error);
                return "user";
            }
        };

        const requireUser = async () => {
            const { data: sessionData, error } = await supabase.auth.getSession();
            if (error || !sessionData?.session) {
                window.location.href = "index.html";
                return;
            }

            // Note: Access control is enforced by Supabase RLS policies.
            // Client-side checks are for UX only and should not be relied upon for security.
        };

        const taBody = document.getElementById("ta-body");
        const taStatus = document.getElementById("ta-status");
        const taMoreBtn = document.getElementById("ta-more");
        const pageSize = 20;
        let taOffset = 0;
        let taRows = [];
        let taHasMore = true;

        const formatFileLabel = (value) => {
            const base = String(value || "Download");
            const extMatch = base.match(/\.([a-z0-9]{1,5})$/i);
            const ext = extMatch ? `.${extMatch[1]}` : "";
            const compact = base.replace(/[^a-z0-9]/gi, "");
            if (compact.length <= 12) return compact || "File";
            return `${compact.slice(0, 12)}...${ext}`;
        };
        const viewModal = document.getElementById("view-modal");
        const closeViewBtn = document.getElementById("close-view");
        const viewTaNumber = document.getElementById("view-ta-number");
        const viewPurpose = document.getElementById("view-purpose");
        const viewDestination = document.getElementById("view-destination");
        const viewTravelDate = document.getElementById("view-travel-date");
        const viewTravelUntil = document.getElementById("view-travel-until");
        const viewFileLink = document.getElementById("view-file-link");

        const renderRows = (rows) => {
            if (!rows.length) {
                taBody.innerHTML = "<tr><td colspan=\"7\">No records yet.</td></tr>";
                return;
            }

            taBody.innerHTML = rows.map((row, index) => {
                const dateText = row.travel_date ? new Date(row.travel_date).toLocaleDateString() : "-";
                const untilText = row.travel_until ? new Date(row.travel_until).toLocaleDateString() : "-";
                const fileUrl = row.file_url || "#";
                const safeName = row.file_name || "Download";
                const displayName = formatFileLabel(safeName);

                return `
                    <tr>
                        <td>
                            <button class="view-btn icon-btn" data-index="${index}" aria-label="View details">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M12 5c5 0 9.3 3 11 7-1.7 4-6 7-11 7S2.7 16 1 12c1.7-4 6-7 11-7Zm0 2C8.3 7 5 9.1 3.4 12 5 14.9 8.3 17 12 17s7-2.1 8.6-5C19 9.1 15.7 7 12 7Zm0 2.2a2.8 2.8 0 1 1 0 5.6 2.8 2.8 0 0 1 0-5.6Z" />
                                </svg>
                            </button>
                        </td>
                        <td>${row.ta_number || "-"}</td>
                        <td><span class="truncate">${row.purpose || "-"}</span></td>
                        <td><span class="truncate">${row.destination || "-"}</span></td>
                        <td>${dateText}</td>
                        <td>${untilText}</td>
                        <td>
                            <a class="link-btn" href="${fileUrl}" target="_blank" rel="noopener">${displayName}</a>
                        </td>
                    </tr>
                `;
            }).join("");

            document.querySelectorAll(".view-btn").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    const index = Number(e.currentTarget.getAttribute("data-index"));
                    const record = rows[index];
                    if (!record) return;

                    viewTaNumber.textContent = record.ta_number || "-";
                    viewPurpose.textContent = record.purpose || "-";
                    viewDestination.textContent = record.destination || "-";
                    viewTravelDate.textContent = record.travel_date
                        ? new Date(record.travel_date).toLocaleDateString()
                        : "-";
                    viewTravelUntil.textContent = record.travel_until
                        ? new Date(record.travel_until).toLocaleDateString()
                        : "-";

                    if (record.file_url) {
                        viewFileLink.href = record.file_url;
                        viewFileLink.textContent = record.file_name || "Open file";
                    } else {
                        viewFileLink.href = "#";
                        viewFileLink.textContent = "No file";
                    }

                    viewModal.classList.add("show");
                });
            });
        };

        const updateTaFooter = () => {
            if (!taRows.length) {
                taStatus.textContent = "No records yet.";
            } else if (!taHasMore) {
                taStatus.textContent = "End of records.";
            } else {
                taStatus.textContent = `Loaded ${taRows.length} record${taRows.length === 1 ? "" : "s"}.`;
            }

            if (taMoreBtn) {
                taMoreBtn.hidden = !taHasMore;
            }
        };

        const loadTravelAuthorities = async (reset = false) => {
            if (reset) {
                taOffset = 0;
                taRows = [];
                taHasMore = true;
                taBody.innerHTML = "<tr><td colspan=\"7\">Loading records...</td></tr>";
            }

            if (!taHasMore) {
                updateTaFooter();
                return;
            }

            taStatus.textContent = "Fetching travel authorities.";
            try {
                const from = taOffset;
                const to = taOffset + pageSize - 1;
                const { data, error } = await supabase
                    .from("travel_authorities")
                    .select("ta_number, purpose, destination, travel_date, travel_until, file_name, file_url, created_at")
                    .order("created_at", { ascending: false })
                    .range(from, to);

                if (error) {
                    throw error;
                }

                const nextRows = data || [];
                taRows = taRows.concat(nextRows);
                taOffset += nextRows.length;
                taHasMore = nextRows.length === pageSize;

                renderRows(taRows);
                updateTaFooter();
            } catch (error) {
                console.error("Dashboard load error:", error);
                taBody.innerHTML = "<tr><td colspan=\"7\">Unable to load records.</td></tr>";
                taStatus.textContent = "Failed to load travel authorities.";
            }
        };
        if (taMoreBtn) {
            taMoreBtn.addEventListener("click", () => {
                loadTravelAuthorities(false);
            });
        }

        closeViewBtn.addEventListener("click", () => {
            viewModal.classList.remove("show");
        });

        viewModal.addEventListener("click", (e) => {
            if (e.target === viewModal) {
                viewModal.classList.remove("show");
            }
        });

        const init = async () => {
            await requireUser();
            await loadTravelAuthorities(true);
        };

        init();
    </script>
</body>
</html>
