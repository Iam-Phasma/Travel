<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTAA - Admin</title>
    <link rel="icon" type="image/png" href="../assets/CHED-Logo.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../header/header.css">
    <link rel="stylesheet" href="../footer/footer.css">
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>
    <div id="header-container"></div>
    <script>
        // Load header HTML
        window.headerLoaded = false;
        fetch('../header/header.html')
            .then(response => response.text())
            .then(data => {
                const headerHTML = data.replace(/HEADER_ASSETS_PATH/g, '../assets');
                document.getElementById('header-container').innerHTML = headerHTML;
                window.headerLoaded = true;
                
                // Initialize date display in header
                const dateElement = document.getElementById('header-date');
                if (dateElement) {
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    const today = new Date();
                    const formattedDate = today.toLocaleDateString('en-US', options);
                    dateElement.textContent = `Today is ${formattedDate}`;
                }
                
                // If initHeaderButtons is already defined, call it
                if (window.initHeaderButtons) {
                    window.initHeaderButtons();
                }
            })
            .catch(error => console.error('Error loading header:', error));
    </script>
    <div class="page-content">
        <div class="page-header-section">
            <h2 class="page-title">Admin Panel</h2>
            <p class="page-description">Manage travel authority records, employees, and system settings.</p>
        </div>
        <div class="panel-switcher">
        <button class="switch-btn active" data-panel="upload-panel">Upload Files</button>
        <button class="switch-btn" data-panel="view-panel">Manage Files </button>
        <button class="switch-btn" data-panel="employees-panel">Manage Employees</button>
        <button class="switch-btn hidden" id="users-panel-btn" data-panel="users-panel">Manage User</button>
    </div>
        <section class="panel" id="upload-panel">
        <h2>Upload Travel Authority</h2>
        <div class="fields">
            <div>
                <label for="ta-number">TA Number <span class="required">*</span></label>
                <div class="input-wrap">
                    <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                            <path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V8h4.5L14 3.5ZM8 12h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                        </svg>
                    </span>
                    <input id="ta-number" type="text" placeholder="0000-00-0000" pattern="\d{4}-\d{2}-\d{4}" maxlength="12" inputmode="numeric" required>
                </div>
            </div>
            <div>
                <label for="purpose">Purpose <span class="required">*</span></label>
                <div class="input-wrap">
                    <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                            <path d="M4 5h16a1 1 0 0 1 1 1v10a3 3 0 0 1-3 3H8a5 5 0 0 1-5-5V6a1 1 0 0 1 1-1Zm1 2v7a3 3 0 0 0 3 3h10a1 1 0 0 0 1-1V7H5Zm3 1h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                        </svg>
                    </span>
                    <input id="purpose" type="text" placeholder="Enter travel purpose" required>
                </div>
            </div>
            <div>
                <label for="destination">Destination <span class="required">*</span></label>
                <div class="input-wrap">
                    <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                            <path d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z" />
                        </svg>
                    </span>
                    <input id="destination" type="text" placeholder="Enter destination" required>
                </div>
            </div>
            <div>
                <label for="employees">Employees <span class="required">*</span></label>
                <div class="multiselect-wrapper">
                    <div class="multiselect-display" id="employees-display">
                        <span class="multiselect-placeholder">Select employees...</span>
                    </div>
                    <div class="multiselect-dropdown" id="employees-dropdown">
                        <div class="multiselect-search-wrapper">
                            <input type="text" class="multiselect-search" id="employees-search" placeholder="Search Employees...">
                        </div>
                        <div class="multiselect-options" id="employees-options">
                            <!-- Options loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="field-row">
                <div>
                    <label for="travel-date">Travel Date <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                            </svg>
                        </span>
                        <input id="travel-date" type="text" placeholder="Select travel date" required>
                    </div>
                </div>
                <div>
                    <label for="travel-until">Travel End</label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                            </svg>
                        </span>
                        <input id="travel-until" type="text" placeholder="Select end date">
                    </div>
                </div>
            </div>
            <div>
                <label for="scan-file">Upload Scanned <span class="required">*</span></label>
                <input id="scan-file" type="file" accept="application/pdf,.pdf" required>
            </div>
            <div class="auto-clear-bottom">
                <label class="checkbox-label">
                    <input type="checkbox" id="auto-clear-checkbox">
                    <span>Clear fields after successful upload</span>
                </label>
            </div>
        </div>
        <div class="upload-controls">
            <span class="status" id="upload-status">Complete the required fields.</span>
            <div class="upload-buttons">
                <button id="clear-upload-btn" type="button" class="secondary-btn">Clear</button>
                <button id="upload-btn" type="button">Upload</button>
            </div>
        </div>
    </section>

        <section class="panel wide-panel hidden" id="view-panel">
        <div class="panel-head">
            <h2>Records</h2>
            <div class="panel-head-actions">
                <button id="admin-export-btn" class="filter-icon-btn" type="button" aria-label="Export to Excel" title="Export to Excel">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                </button>
                <button id="admin-filter-toggle-btn" class="filter-icon-btn" type="button" aria-label="Toggle filters" title="Filter">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                        <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                    </svg>
                </button>
                <span class="pill">Admin Access</span>
            </div>
        </div>
        <div id="admin-filter-panel" class="filter-panel">
            <div class="filter-content">
                <h3>Filter Options</h3>
                <div class="filter-mode">
                    <label class="checkbox-label">
                        <input type="checkbox" id="admin-filter-match-all">
                        <span>Match all filters (AND)</span>
                    </label>
                    <p class="filter-mode-note">Unchecked: Match any filter (OR)</p>
                </div>
                <div class="filter-fields">
                    <div class="filter-field">
                        <label for="admin-filter-ta-number">TA Number</label>
                        <input type="text" id="admin-filter-ta-number" placeholder="0000-00-0000" maxlength="12">
                    </div>
                    <div class="filter-field">
                        <label for="admin-filter-employee">Employee</label>
                        <select id="admin-filter-employee" class="filter-select">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="filter-field">
                        <label for="admin-filter-year">Year</label>
                        <select id="admin-filter-year" class="filter-select">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="filter-field">
                        <label for="admin-filter-travel-date">Travel Date</label>
                        <input type="text" id="admin-filter-travel-date" placeholder="Select date">
                    </div>
                </div>
                <div class="filter-actions">
                    <button id="admin-clear-filter-btn" class="filter-btn clear-btn" type="button">Clear Filter</button>
                    <button id="admin-apply-filter-btn" class="filter-btn apply-btn" type="button">Apply Filter</button>
                </div>
            </div>
        </div>
        <div class="table-wrap max-rows-10">
            <table class="data-table" aria-describedby="view-status">
                <thead>
                    <tr>
                        <th scope="col">View</th>
                        <th scope="col">TA Number</th>
                        <th scope="col">Purpose</th>
                        <th scope="col">Destination</th>
                        <th scope="col">Employees</th>
                        <th scope="col">Travel Date</th>
                        <th scope="col">Travel End</th>
                        <th scope="col">File</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="view-body">
                    <tr>
                        <td colspan="9">Loading records...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="table-footer">
            <span class="status" id="view-status">Fetching travel authorities.</span>
            <button id="view-more" class="pagination-btn" type="button">Load more</button>
        </div>
    </section>

        <div id="employees-panel-container"></div>

        <div id="users-panel-container"></div>

    </div>
    <!-- End of page-content -->

    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete this travel authority record? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancel-delete">Cancel</button>
                <button class="modal-btn confirm" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <div id="employees-modals-container"></div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-modal-title">Confirm Action</h3>
            <p id="confirm-modal-message">Are you sure?</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancel-confirm">Cancel</button>
                <button class="modal-btn confirm" id="confirm-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <div id="view-modal" class="modal">
        <div class="modal-content modal-form">
            <h3>Travel Authority Details</h3>
            <div class="detail-list">
                <div class="detail-row">
                    <span class="detail-label">TA Number</span>
                    <span class="detail-value" id="view-ta-number">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Purpose</span>
                    <span class="detail-value" id="view-purpose">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Destination</span>
                    <span class="detail-value" id="view-destination">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Employees</span>
                    <span class="detail-value" id="view-employees">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Travel Date</span>
                    <span class="detail-value" id="view-travel-date">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Travel End</span>
                    <span class="detail-value" id="view-travel-until">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">File</span>
                    <a class="file-link" id="view-file-link" href="#" target="_blank" rel="noopener">Open file</a>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" id="view-edit-btn" style="background: var(--sea); color: white;">Edit</button>
                <button class="modal-btn cancel" id="close-view">Close</button>
            </div>
        </div>
    </div>

    <div id="export-modal" class="modal">
        <div class="modal-content modal-form">
            <h3>Export to Excel</h3>
            <p>Select years to include in the export.</p>
            <div class="fields">
                <div>
                    <label class="checkbox-label">
                        <input type="checkbox" id="export-all-years">
                        <span>All Years</span>
                    </label>
                </div>
                <div id="export-years-list" style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
                    <!-- Year checkboxes will be populated dynamically -->
                </div>
            </div>
            <span class="status hidden" id="export-status"></span>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancel-export">Cancel</button>
                <button class="modal-btn confirm" id="confirm-export">Export</button>
            </div>
        </div>
    </div>

    <div id="update-modal" class="modal">
        <div class="modal-content modal-form">
            <h3>Update TA</h3>
            <p>Updating will overwrite the existing record.</p>
            <div class="fields">
                <div>
                    <label for="update-ta-number">TA Number <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V8h4.5L14 3.5ZM8 12h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                            </svg>
                        </span>
                        <input id="update-ta-number" type="text" placeholder="0000-00-0000" pattern="\d{4}-\d{2}-\d{4}" maxlength="12" inputmode="numeric" required>
                    </div>
                </div>
                <div>
                    <label for="update-purpose">Purpose <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M4 5h16a1 1 0 0 1 1 1v10a3 3 0 0 1-3 3H8a5 5 0 0 1-5-5V6a1 1 0 0 1 1-1Zm1 2v7a3 3 0 0 0 3 3h10a1 1 0 0 0 1-1V7H5Zm3 1h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                            </svg>
                        </span>
                        <input id="update-purpose" type="text" placeholder="Enter travel purpose" required>
                    </div>
                </div>
                <div>
                    <label for="update-destination">Destination <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z" />
                            </svg>
                        </span>
                        <input id="update-destination" type="text" placeholder="Enter destination" required>
                    </div>
                </div>
                <div>
                    <label for="update-employees">Employees <span class="required">*</span></label>
                    <div class="multiselect-wrapper">
                        <div class="multiselect-display" id="update-employees-display">
                            <span class="multiselect-placeholder">Select employees...</span>
                        </div>
                        <div class="multiselect-dropdown" id="update-employees-dropdown">
                            <div class="multiselect-search-wrapper">
                                <input type="text" class="multiselect-search" id="update-employees-search" placeholder="Search employees...">
                            </div>
                            <div class="multiselect-options" id="update-employees-options">
                                <!-- Options loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="field-row">
                    <div>
                        <label for="update-travel-date">Travel Date <span class="required">*</span></label>
                        <div class="input-wrap">
                            <span class="icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                                </svg>
                            </span>
                            <input id="update-travel-date" type="text" placeholder="Select travel date" required>
                        </div>
                    </div>
                    <div>
                        <label for="update-travel-until">Travel End</label>
                        <div class="input-wrap">
                            <span class="icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                                </svg>
                            </span>
                            <input id="update-travel-until" type="text" placeholder="Select end date">
                        </div>
                    </div>
                </div>
                <div>
                    <label for="update-scan-file">Upload Scanned</label>
                    <input id="update-scan-file" type="file" accept="application/pdf,.pdf">
                    <p class="disclaimer">Leave empty to keep the current file.</p>
                </div>
            </div>
            <span class="status hidden" id="update-status"></span>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancel-update">Cancel</button>
                <button class="modal-btn confirm" id="confirm-update">Update</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="employees/employees.js"></script>
    <script type="module">
        // Import Supabase
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
        import { supabaseConfig } from "../config.js";

        // Initialize Supabase
        const supabase = createClient(supabaseConfig.url, supabaseConfig.anonKey);

        // Load employee panel and modals
        const employeePanelLoaded = Promise.all([
            fetch('employees/employees-panel.html').then(r => r.text()),
            fetch('employees/employees-modals.html').then(r => r.text())
        ]).then(([panelHTML, modalsHTML]) => {
            document.getElementById('employees-panel-container').innerHTML = panelHTML;
            document.getElementById('employees-modals-container').innerHTML = modalsHTML;
            
            // Initialize employee management after loading
            if (window.initEmployeeManagement) {
                window.initEmployeeManagement(supabase);
            }
            return true;
        }).catch(error => {
            console.error('Error loading employee components:', error);
            return false;
        });

        // Load users panel
        const usersPanelLoaded = fetch('users/users-panel.html')
            .then(r => r.text())
            .then(panelHTML => {
                document.getElementById('users-panel-container').innerHTML = panelHTML;
                return true;
            })
            .catch(error => {
                console.error('Error loading users panel:', error);
                return false;
            });

        // Periodically check if current admin's access_enabled is still true
        const checkAccessEnabled = async () => {
            try {
                const { data: sessionData } = await supabase.auth.getSession();
                const user = sessionData?.session?.user;
                if (!user) return;

                const { data, error } = await supabase
                    .from("profiles")
                    .select("access_enabled")
                    .eq("id", user.id)
                    .maybeSingle();

                if (error) {
                    console.error("Error checking access_enabled:", error);
                    return;
                }

                if (data && data.access_enabled === false) {
                    // Show toast notification
                    const toastEl = document.getElementById("toast");
                    if (toastEl) {
                        toastEl.textContent = "Access disabled: You have been logged out.";
                        toastEl.classList.add("show", "toast--error");
                    }
                    // Immediate logout
                    await supabase.auth.signOut();
                    localStorage.removeItem('admin_session_token');
                    localStorage.removeItem('adminActivePanel');
                    window.location.href = '../index.html';
                }
            } catch (err) {
                console.error("Error in checkAccessEnabled:", err);
            }
        };
        // Check every 5 seconds
        setInterval(checkAccessEnabled, 5000);
        setTimeout(checkAccessEnabled, 3000); // First check after 3 seconds

        // Single-session enforcement for admin users
        // ⚠️ WARNING: This uses localStorage which users can view/modify via DevTools
        // However, we validate against the database token, so manipulation won't grant access
        // The database session_token field is the source of truth
        const checkAdminSession = async () => {
            try {
                const { data: sessionData } = await supabase.auth.getSession();
                const user = sessionData?.session?.user;
                if (!user) {
                    return;
                }

                const localToken = localStorage.getItem('admin_session_token');
                if (!localToken) {
                    return;
                }

                const { data, error } = await supabase
                    .from("profiles")
                    .select("session_token")
                    .eq("id", user.id)
                    .maybeSingle();

                if (error) {
                    // Session token fetch failed, skip validation
                    return;
                }

                if (!data) {
                    return;
                }

                // Only logout if database token exists AND doesn't match
                // If database token is null, update it (in case initial update failed)
                if (data.session_token === null) {
                    const { error: updateError } = await supabase
                        .from("profiles")
                        .update({ session_token: localToken })
                        .eq("id", user.id);
                    
                    if (updateError) {
                        // Session token update failed, continue without logging
                    }
                } else if (data.session_token !== localToken) {
                    // Session token mismatch - another device logged in
                    
                    // Show toast notification
                    const toastEl = document.getElementById("toast");
                    if (toastEl) {
                        toastEl.textContent = "Logged out: Another device logged into this account.";
                        toastEl.classList.add("show", "toast--warning");
                    }
                    
                    // Wait 2 seconds for user to see the toast
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    await supabase.auth.signOut();
                    localStorage.removeItem('admin_session_token');
                    localStorage.removeItem('adminActivePanel');
                    window.location.href = '../index.html';
                }
            } catch (err) {
                console.error("Error in checkAdminSession:", err);
            }
        };

        // Check session every 5 seconds, start after initial delay
        setInterval(checkAdminSession, 5000);
        setTimeout(checkAdminSession, 3000); // First check after 3 seconds

        const getUserRole = async (userId) => {
            try {
                const { data, error } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", userId)
                    .maybeSingle();

                if (error) {
                    throw error;
                }

                return data?.role || "user";
            } catch (error) {
                console.error("Role lookup error:", error);
                return "user";
            }
        };

        const requireAdmin = async () => {
            const { data: sessionData, error } = await supabase.auth.getSession();
            if (error || !sessionData?.session) {
                // No valid session - redirect to login
                console.warn("No valid session found. Redirecting to login.");
                window.location.href = "../index.html";
                return null;
            }

            const user = sessionData.session.user;
            
            // CRITICAL: Verify admin/super role from database (not localStorage which can be manipulated)
            const role = await getUserRole(user.id);
            
            if (role !== "admin" && role !== "super") {
                // User is not an admin or super - block access silently
                console.warn("Access denied: User is not an admin or super. Redirecting to dashboard.");
                window.location.href = "../dashboard/dashboard.html";
                return null;
            }
            
            return role; // Return the role for UI customization

            // Additional check: Verify session token matches database
            const localToken = localStorage.getItem('admin_session_token');
            if (!localToken) {
                console.warn("No session token found. Redirecting to login.");
                window.location.href = "../index.html";
                return;
            }

            const { data: profileData, error: profileError } = await supabase
                .from("profiles")
                .select("session_token")
                .eq("id", user.id)
                .maybeSingle();

            if (profileError || !profileData) {
                console.error("Failed to verify session token:", profileError);
                window.location.href = "../index.html";
                return;
            }

            // If DB token exists and doesn't match, another session is active
            if (profileData.session_token && profileData.session_token !== localToken) {
                console.warn("Session token mismatch. Another device logged in.");
                await supabase.auth.signOut();
                localStorage.removeItem('admin_session_token');
                localStorage.removeItem('adminActivePanel');
                window.location.href = "../index.html";
                return;
            }

            // Update token in DB if it's null (recovery from failed initial update)
            if (!profileData.session_token) {
                await supabase
                    .from("profiles")
                    .update({ session_token: localToken })
                    .eq("id", user.id);
            }

            // Note: Actual access control for admin operations (upload, delete) 
            // is enforced by Supabase RLS policies, not this client-side check.
            // This check is for UX and adds defense-in-depth, but RLS is the real security.
        };

        // Periodic session validation to detect session termination
        // WARNING: Users can disable this in DevTools, so server-side security (RLS) is critical
        const validateAdminSession = async () => {
            const { data: sessionData, error } = await supabase.auth.getSession();
            if (error || !sessionData?.session) {
                console.warn("Session expired or invalid. Redirecting to login.");
                window.location.href = "../index.html";
                return;
            }

            // Re-verify admin/super role
            const role = await getUserRole(sessionData.session.user.id);
            if (role !== "admin" && role !== "super") {
                console.warn("User is no longer an admin or super. Redirecting.");
                await supabase.auth.signOut();
                localStorage.removeItem('adminActivePanel');
                window.location.href = "../index.html";
            }
        };

        // Check session validity every 30 seconds
        setInterval(validateAdminSession, 30000);

        // Define header button initialization function
        window.initHeaderButtons = () => {
            const userMenuBtn = document.getElementById('user-menu-btn');
            const headerPopup = document.getElementById('header-popup-panel');
            const settingsOption = document.getElementById('header-settings-option');
            const logoutOption = document.getElementById('header-logout-option');
            const userEmailElement = document.getElementById('header-user-email');

            // Fetch and display user email
            if (userEmailElement) {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    if (session?.user?.email) {
                        userEmailElement.textContent = session.user.email;
                    } else {
                        userEmailElement.textContent = 'Not available';
                    }
                }).catch(() => {
                    userEmailElement.textContent = 'Not available';
                });
            }

            // Toggle popup when user menu button is clicked
            if (userMenuBtn && headerPopup) {
                userMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    headerPopup.classList.toggle('show');
                });
            }

            // Handle settings option click
            if (settingsOption && headerPopup) {
                settingsOption.addEventListener('click', () => {
                    headerPopup.classList.remove('show');
                    document.getElementById('settings-modal').classList.add('show');
                });
            }

            // Handle logout option click
            if (logoutOption && headerPopup) {
                logoutOption.addEventListener('click', async () => {
                    headerPopup.classList.remove('show');
                    
                    // Show confirmation dialog
                    const confirmed = await showConfirmation(
                        'Confirm Logout',
                        'Are you sure you want to log out?'
                    );

                    if (!confirmed) {
                        return; // User cancelled
                    }

                    try {
                        // Clear admin session token and panel memory
                        localStorage.removeItem('admin_session_token');
                        localStorage.removeItem('adminActivePanel');
                        await supabase.auth.signOut();
                        window.location.href = "../index.html";
                    } catch (error) {
                        console.error("Logout error:", error);
                        localStorage.removeItem('admin_session_token');
                        localStorage.removeItem('adminActivePanel');
                        window.location.href = "../index.html";
                    }
                });
            }

            // Close popup when clicking outside
            document.addEventListener('click', (e) => {
                if (headerPopup && !headerPopup.contains(e.target) && 
                    e.target !== userMenuBtn && !userMenuBtn?.contains(e.target)) {
                    headerPopup.classList.remove('show');
                }
            });
        };

        const uploadStatus = document.getElementById("upload-status");
        const taNumberInput = document.getElementById("ta-number");
        const purposeInput = document.getElementById("purpose");
        const destinationInput = document.getElementById("destination");
        const travelDateInput = document.getElementById("travel-date");
        const travelUntilInput = document.getElementById("travel-until");
        const scanFileInput = document.getElementById("scan-file");

        // PDF compression function with multiple strategies
        const compressPDF = async (file, maxSizeMB = 5) => {
            // Only process PDFs
            if (file.type !== 'application/pdf') {
                return file;
            }

            try {
                const arrayBuffer = await file.arrayBuffer();
                const { PDFDocument } = window.PDFLib;
                const pdfDoc = await PDFDocument.load(arrayBuffer);

                // Try multiple compression strategies
                let compressedPdfBytes;
                
                // Strategy 1: Maximum compression with object streams
                try {
                    compressedPdfBytes = await pdfDoc.save({
                        useObjectStreams: true,
                        addDefaultPage: false,
                        objectsPerTick: 50
                    });
                } catch (e) {
                    // Strategy 2: Fallback without object streams
                    compressedPdfBytes = await pdfDoc.save({
                        useObjectStreams: false,
                        addDefaultPage: false
                    });
                }

                const compressedSize = compressedPdfBytes.length;

                // Create a new File object from the compressed bytes
                const compressedFile = new File([compressedPdfBytes], file.name, {
                    type: 'application/pdf',
                    lastModified: Date.now()
                });

                // Warn if still too large
                if (compressedSize > maxSizeMB * 1024 * 1024) {
                    console.warn(`PDF still exceeds ${maxSizeMB}MB after compression. Current size: ${(compressedSize / 1024 / 1024).toFixed(2)}MB`);
                }

                return compressedFile;
            } catch (error) {
                console.error('PDF compression error:', error);
                // Return original file if compression fails
                return file;
            }
        };

        // Multi-select employees functionality
        let employeesList = [];
        window.adminEmployeesList = employeesList;
        let selectedEmployees = [];
        let updateSelectedEmployees = [];

        const loadEmployees = async () => {
            try {
                const { data, error } = await supabase
                    .from("employee_list")
                    .select("name, is_active")
                    .order("is_active", { ascending: false })
                    .order("name", { ascending: true });

                if (error) throw error;
                employeesList = data || [];
                renderEmployeesOptions();
                renderUpdateEmployeesOptions();
            } catch (error) {
                console.error("Failed to load employees:", error);
                employeesList = [];
            }
        };

        const createMultiSelect = (displayId, dropdownId, searchId, optionsId, selectedArray) => {
            const display = document.getElementById(displayId);
            const dropdown = document.getElementById(dropdownId);
            const search = document.getElementById(searchId);
            const options = document.getElementById(optionsId);

            const updateDisplay = () => {
                if (selectedArray.length === 0) {
                    display.innerHTML = '<span class=\"multiselect-placeholder\">Select employees...</span>';
                } else {
                    display.innerHTML = selectedArray.map(name => 
                        `<span class=\"multiselect-tag\">${name}<button type=\"button\" class=\"multiselect-remove\" data-name=\"${name}\">&times;</button></span>`
                    ).join('');
                    
                    display.querySelectorAll('.multiselect-remove').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const name = e.target.getAttribute('data-name');
                            const index = selectedArray.indexOf(name);
                            if (index > -1) {
                                selectedArray.splice(index, 1);
                                updateDisplay();
                                renderOptions();
                            }
                        });
                    });
                }
            };

            const renderOptions = () => {
                const searchTerm = search.value.toLowerCase();
                const filtered = employeesList.filter(emp => 
                    emp.name.toLowerCase().includes(searchTerm) && !selectedArray.includes(emp.name)
                );
                
                if (filtered.length === 0) {
                    options.innerHTML = '<div class=\"multiselect-no-options\">No options available</div>';
                } else {
                    options.innerHTML = filtered.map(emp => {
                        const inactiveClass = emp.is_active === false ? ' inactive-employee' : '';
                        const inactiveLabel = emp.is_active === false ? ' <span class=\"inactive-label\">(Inactive)</span>' : '';
                        return `<div class=\"multiselect-option${inactiveClass}\" data-name=\"${emp.name}\">${emp.name}${inactiveLabel}</div>`;
                    }).join('');
                    
                    options.querySelectorAll('.multiselect-option').forEach(opt => {
                        opt.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const name = opt.getAttribute('data-name');
                            if (!selectedArray.includes(name)) {
                                selectedArray.push(name);
                                updateDisplay();
                                renderOptions();
                            }
                        });
                    });
                }
            };

            display.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('show');
                if (dropdown.classList.contains('show')) {
                    search.focus();
                }
            });

            search.addEventListener('input', renderOptions);
            search.addEventListener('click', (e) => e.stopPropagation());

            document.addEventListener('click', () => {
                dropdown.classList.remove('show');
            });

            return { updateDisplay, renderOptions };
        };

        const employeesMultiSelect = createMultiSelect(
            'employees-display',
            'employees-dropdown',
            'employees-search',
            'employees-options',
            selectedEmployees
        );

        const updateEmployeesMultiSelect = createMultiSelect(
            'update-employees-display',
            'update-employees-dropdown',
            'update-employees-search',
            'update-employees-options',
            updateSelectedEmployees
        );

        const renderEmployeesOptions = () => {
            employeesMultiSelect.renderOptions();
        };
        window.adminRenderEmployeesOptions = renderEmployeesOptions;

        const renderUpdateEmployeesOptions = () => {
            updateEmployeesMultiSelect.renderOptions();
        };
        window.adminRenderUpdateEmployeesOptions = renderUpdateEmployeesOptions;

        window.flatpickr(travelDateInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        window.flatpickr(travelUntilInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        const isValidTaNumber = (value) => /^\d{4}-\d{2}-\d{4}$/.test(value);
        const formatTaNumber = (value) => {
            const digits = value.replace(/\D/g, "").slice(0, 10);
            const part1 = digits.slice(0, 4);
            const part2 = digits.slice(4, 6);
            const part3 = digits.slice(6, 10);
            if (digits.length <= 4) return part1;
            if (digits.length <= 6) return `${part1}-${part2}`;
            return `${part1}-${part2}-${part3}`;
        };

        const formatFileLabel = (value) => {
            const base = String(value || "Download");
            const extMatch = base.match(/\.([a-z0-9]{1,5})$/i);
            const ext = extMatch ? `.${extMatch[1]}` : "";
            const nameWithoutExt = extMatch ? base.slice(0, -ext.length) : base;
            const compact = nameWithoutExt.replace(/[^a-z0-9-]/gi, "");
            if (compact.length <= 12) return compact + ext || "File";
            return `${compact.slice(0, 12)}...${ext}`;
        };

        const bindTaFormatter = (input) => {
            input.addEventListener("input", () => {
                input.value = formatTaNumber(input.value);
            });
        };

        scanFileInput.addEventListener("change", () => {
            if (scanFileInput.files.length > 0) {
                uploadStatus.textContent = `Selected: ${scanFileInput.files[0].name}`;
            } else {
                uploadStatus.textContent = "Complete the required fields.";
            }
        });

        document.getElementById("upload-btn").addEventListener("click", async () => {
            const taNumber = taNumberInput.value.trim();
            const purpose = purposeInput.value.trim();
            const destination = destinationInput.value.trim();
            const travelDate = travelDateInput.value;
            let travelUntil = travelUntilInput.value;
            const employees = selectedEmployees.join(", ");

            const file = scanFileInput.files[0];

            if (!taNumber || !purpose || !destination || !travelDate || !file || selectedEmployees.length === 0) {
                uploadStatus.textContent = "Please fill in all required fields.";
                uploadStatus.classList.add("status--error");
                uploadStatus.classList.remove("status--shake");
                void uploadStatus.offsetWidth;
                uploadStatus.classList.add("status--shake");
                return;
            }

            if (!isValidTaNumber(taNumber)) {
                uploadStatus.textContent = "TA Number must be in the format 0000-00-0000.";
                uploadStatus.classList.add("status--error");
                uploadStatus.classList.remove("status--shake");
                void uploadStatus.offsetWidth;
                uploadStatus.classList.add("status--shake");
                return;
            }

            if (!travelUntil) {
                travelUntil = travelDate;
                travelUntilInput.value = travelDate;
            }

            if (travelUntil) {
                const start = new Date(`${travelDate}T00:00:00`);
                const end = new Date(`${travelUntil}T00:00:00`);
                if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
                    uploadStatus.textContent = "Please enter valid dates.";
                    uploadStatus.classList.add("status--error");
                    uploadStatus.classList.remove("status--shake");
                    void uploadStatus.offsetWidth;
                    uploadStatus.classList.add("status--shake");
                    return;
                }

                if (start > end) {
                    uploadStatus.textContent = "Travel date cannot be after travel end.";
                    uploadStatus.classList.add("status--error");
                    uploadStatus.classList.remove("status--shake");
                    void uploadStatus.offsetWidth;
                    uploadStatus.classList.add("status--shake");
                    return;
                }
            }

            try {
                // Show initial file size
                const originalSizeMB = (file.size / 1024 / 1024).toFixed(2);
                uploadStatus.textContent = `File: ${originalSizeMB}MB - Compressing...`;
                uploadStatus.classList.remove("status--error");

                // Compress PDF before uploading
                const processedFile = await compressPDF(file);
                const compressedSizeMB = (processedFile.size / 1024 / 1024).toFixed(2);
                
                // Check if compressed file is still too large (adjust maxAllowedMB based on your storage bucket limit)
                const maxAllowedMB = 5;
                if (processedFile.size > maxAllowedMB * 1024 * 1024) {
                    uploadStatus.textContent = `File too large: ${compressedSizeMB}MB (max ${maxAllowedMB}MB). Please use a smaller PDF or compress it externally.`;
                    uploadStatus.classList.add("status--error");
                    uploadStatus.classList.remove("status--shake");
                    void uploadStatus.offsetWidth;
                    uploadStatus.classList.add("status--shake");
                    return;
                }

                uploadStatus.textContent = `Uploading ${compressedSizeMB}MB...`;

                // Verify user is authenticated
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                if (sessionError || !sessionData?.session) {
                    throw new Error("No active session. Please log in again.");
                }

                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    throw new Error("Not authenticated");
                }

                const { data: profile, error: profileError } = await supabase
                    .from("profiles")
                    .select("id, role")
                    .eq("id", user.id)
                    .maybeSingle();

                // Allow both admin AND super users to upload
                if (profileError || (profile?.role !== "admin" && profile?.role !== "super")) {
                    throw new Error("Not authorized to upload.");
                }

                const safeTa = taNumber.replace(/[^a-z0-9-_]/gi, "_");
                const safeDate = travelDate.replace(/[^0-9-]/g, "-");
                
                // Extract file extension and rename file to TA number
                const fileExtension = processedFile.name.substring(processedFile.name.lastIndexOf('.'));
                const newFileName = `${taNumber}${fileExtension}`;
                const filePath = `travel-authorities/${safeTa}/${safeDate}/${newFileName}`;

                const { error: uploadError } = await supabase
                    .storage
                    .from("ta-files")
                    .upload(filePath, processedFile, { upsert: false });

                if (uploadError) {
                    throw new Error(`Storage upload failed: ${uploadError.message || "Unknown error"}`);
                }

                const { data: publicUrlData } = supabase
                    .storage
                    .from("ta-files")
                    .getPublicUrl(filePath);

                const fileUrl = publicUrlData.publicUrl;

                // Use minimal returning: some RLS setups allow INSERT but prevent RETURNING rows.
                // Requesting `returning: 'minimal'` avoids a false-positive "no rows returned" error
                const { error: insertError } = await supabase
                    .from("travel_authorities")
                    .insert(
                        [
                            {
                                ta_number: taNumber,
                                purpose: purpose,
                                destination: destination,
                                employees: employees,
                                travel_date: travelDate,
                                travel_until: travelUntil,
                                file_name: newFileName,
                                file_url: fileUrl
                            }
                        ],
                        { returning: "minimal" }
                    );

                if (insertError) {
                    console.debug("[upload] insertError:", insertError);

                    const errMsg = insertError.message || "";

                    // If RETURNING is blocked by RLS Postgres may surface the "no rows were returned after insert" message.
                    // Treat this specific case as a *likely* success for UX, but log details so it's easy to diagnose.
                    if (errMsg.includes("no rows were returned after insert")) {
                        console.warn("[upload] INSERT returned no rows — likely RETURNING blocked by RLS. Attempting verification (best-effort).");
                        try {
                            const { data: verifyData, error: verifyError } = await supabase
                                .from("travel_authorities")
                                .select("ta_number")
                                .eq("ta_number", taNumber)
                                .maybeSingle();

                            console.debug("[upload] verification result:", { verifyData, verifyError });

                            if (verifyError) {
                                console.warn("[upload] verification SELECT failed (probably SELECT policy prevents reading):", verifyError);
                            } else if (verifyData) {
                                console.info("[upload] verification SELECT found the inserted row.");
                            } else {
                                console.warn("[upload] verification SELECT returned no row — this may be due to a restrictive SELECT policy.");
                            }
                        } catch (verifyErr) {
                            console.error("[upload] verification query threw:", verifyErr);
                        }

                        // UX fallback: treat as success because INSERT likely succeeded even though RETURNING is blocked.
                        uploadStatus.textContent = "Upload complete (RETURNING blocked by RLS).";

                        if (typeof loadTravelAuthorities === "function") {
                            await loadTravelAuthorities(true);
                        }

                        const autoClearCheckbox = document.getElementById("auto-clear-checkbox");
                        if (autoClearCheckbox && autoClearCheckbox.checked) {
                            taNumberInput.value = "";
                            purposeInput.value = "";
                            destinationInput.value = "";
                            travelDateInput.value = "";
                            travelUntilInput.value = "";
                            scanFileInput.value = "";
                            selectedEmployees.length = 0;
                            employeesMultiSelect.updateDisplay();
                            employeesMultiSelect.renderOptions();
                            uploadStatus.textContent = "Upload complete. Fields cleared.";
                        }

                        // Log an actionable reminder for diagnostics
                        console.warn("[upload] NOTE: update the SELECT RLS policy for `travel_authorities` if you need INSERT ... RETURNING to return rows to the client.");
                        return;
                    }

                    // Non-RETURNING-related failures: cleanup and surface the error as before.
                    try {
                        const { error: removeError } = await supabase.storage.from("ta-files").remove([filePath]);
                        if (removeError) console.warn("Cleanup: failed to remove uploaded file after DB error:", removeError);
                    } catch (cleanupErr) {
                        console.warn("Cleanup: unexpected error while removing uploaded file:", cleanupErr);
                    }

                    if (insertError.code === '23505' || insertError.message?.includes('duplicate key') || insertError.message?.includes('unique constraint')) {
                        throw new Error(`TA Number ${taNumber} already exists in the database.`);
                    }

                    console.error("Database insert error (travel_authorities):", insertError);
                    throw new Error(`Database insert failed: ${insertError.message || "Unknown error"}`);
                }

                // NOTE: don't treat an empty `data` return from insert as a failure when using `returning: 'minimal'`.
                // The row can still be present in the DB even if RETURNING is blocked by RLS/permissions.

                uploadStatus.textContent = "Upload complete.";
                
                // Clear fields if auto-clear is enabled
                const autoClearCheckbox = document.getElementById("auto-clear-checkbox");
                if (autoClearCheckbox && autoClearCheckbox.checked) {
                    taNumberInput.value = "";
                    purposeInput.value = "";
                    destinationInput.value = "";
                    travelDateInput.value = "";
                    travelUntilInput.value = "";
                    scanFileInput.value = "";
                    selectedEmployees.length = 0;
                    employeesMultiSelect.updateDisplay();
                    employeesMultiSelect.renderOptions();
                    uploadStatus.textContent = "Upload complete. Fields cleared.";
                }
            } catch (error) {
                console.error("Upload error:", error);
                const message = error && error.message ? error.message : "Please try again.";
                uploadStatus.textContent = `Upload failed: ${message}`;
                uploadStatus.classList.add("status--error");
                uploadStatus.classList.remove("status--shake");
                void uploadStatus.offsetWidth;
                uploadStatus.classList.add("status--shake");
            }
        });

        // Clear upload fields button
        document.getElementById("clear-upload-btn").addEventListener("click", () => {
            taNumberInput.value = "";
            purposeInput.value = "";
            destinationInput.value = "";
            travelDateInput.value = "";
            travelUntilInput.value = "";
            scanFileInput.value = "";
            selectedEmployees.length = 0;
            employeesMultiSelect.updateDisplay();
            employeesMultiSelect.renderOptions();
            uploadStatus.textContent = "Fields cleared.";
            uploadStatus.classList.remove("status--error");
        });

        // Panel switching logic
        const switchButtons = document.querySelectorAll(".switch-btn");
        const uploadPanel = document.getElementById("upload-panel");
        const viewPanel = document.getElementById("view-panel");

        switchButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const targetPanel = btn.getAttribute("data-panel");
                
                // Persist active panel
                localStorage.setItem("adminActivePanel", targetPanel);

                // Update active button
                switchButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");

                // Get dynamically loaded panels (they're loaded asynchronously)
                const employeesPanel = document.getElementById("employees-panel");
                const usersPanel = document.getElementById("users-panel");

                // Show/hide panels
                uploadPanel.classList.add("hidden");
                viewPanel.classList.add("hidden");
                if (employeesPanel) employeesPanel.classList.add("hidden");
                if (usersPanel) usersPanel.classList.add("hidden");
                
                if (targetPanel === "upload-panel") {
                    uploadPanel.classList.remove("hidden");
                } else if (targetPanel === "view-panel") {
                    viewPanel.classList.remove("hidden");
                    loadTravelAuthorities(true);
                } else if (targetPanel === "employees-panel") {
                    if (employeesPanel) {
                        employeesPanel.classList.remove("hidden");
                        // Call renderEmployeeList if it exists on window
                        if (window.employeeRenderList) {
                            window.employeeRenderList();
                        }
                    }
                } else if (targetPanel === "users-panel") {
                    if (usersPanel) {
                        usersPanel.classList.remove("hidden");
                        // Wait for panel to load before calling loadUsers
                        usersPanelLoaded.then(() => loadUsers());
                    }
                }
            });
        });

        // Table view functionality
        const viewBody = document.getElementById("view-body");
                const viewStatus = document.getElementById("view-status");
                const viewMoreBtn = document.getElementById("view-more");
        const deleteModal = document.getElementById("delete-modal");
        const viewModal = document.getElementById("view-modal");
        const updateModal = document.getElementById("update-modal");
        const confirmModal = document.getElementById("confirm-modal");
        const confirmModalTitle = document.getElementById("confirm-modal-title");
        const confirmModalMessage = document.getElementById("confirm-modal-message");
        const cancelConfirmBtn = document.getElementById("cancel-confirm");
        const confirmConfirmBtn = document.getElementById("confirm-confirm");
                const cancelDeleteBtn = document.getElementById("cancel-delete");
                const closeViewBtn = document.getElementById("close-view");
        const confirmDeleteBtn = document.getElementById("confirm-delete");
        const cancelUpdateBtn = document.getElementById("cancel-update");
        const confirmUpdateBtn = document.getElementById("confirm-update");
        const viewTaNumber = document.getElementById("view-ta-number");
        const viewPurpose = document.getElementById("view-purpose");
        const viewDestination = document.getElementById("view-destination");
        const viewEmployees = document.getElementById("view-employees");
        const viewTravelDate = document.getElementById("view-travel-date");
        const viewTravelUntil = document.getElementById("view-travel-until");
        const viewFileLink = document.getElementById("view-file-link");
        const updateTaInput = document.getElementById("update-ta-number");
        const updatePurposeInput = document.getElementById("update-purpose");
        const updateDestinationInput = document.getElementById("update-destination");
        const updateTravelDateInput = document.getElementById("update-travel-date");
        const updateTravelUntilInput = document.getElementById("update-travel-until");
        const updateScanFileInput = document.getElementById("update-scan-file");
        const updateStatus = document.getElementById("update-status");
        const toast = document.getElementById("toast");
        bindTaFormatter(taNumberInput);
        bindTaFormatter(updateTaInput);
        
        // Real-time TA number validation for upload modal
        let taCheckTimer = null;
        taNumberInput.addEventListener("input", async () => {
            const taNumber = taNumberInput.value.trim();
            
            // Clear existing timer
            if (taCheckTimer) {
                clearTimeout(taCheckTimer);
            }
            
            // Only check if TA number is valid (matches pattern)
            if (isValidTaNumber(taNumber)) {
                // Debounce the database check by 500ms
                taCheckTimer = setTimeout(async () => {
                    try {
                        const { data, error } = await supabase
                            .from("travel_authorities")
                            .select("ta_number")
                            .eq("ta_number", taNumber)
                            .maybeSingle();
                        
                        if (error && error.code !== 'PGRST116') {
                            // PGRST116 is "no rows returned" - that's expected if TA doesn't exist
                            console.error("Error checking TA number:", error);
                            return;
                        }
                        
                        if (data) {
                            // TA number already exists
                            showToast(`TA ${taNumber} already exists in the database.`);
                        }
                    } catch (err) {
                        console.error("Error checking TA number:", err);
                    }
                }, 500);
            }
        });

        // Real-time TA number validation for update modal
        let updateTaCheckTimer = null;
        updateTaInput.addEventListener("input", async () => {
            const taNumber = updateTaInput.value.trim();
            
            // Clear existing timer
            if (updateTaCheckTimer) {
                clearTimeout(updateTaCheckTimer);
            }
            
            // Only check if TA number is valid (matches pattern)
            if (isValidTaNumber(taNumber)) {
                // Debounce the database check by 500ms
                updateTaCheckTimer = setTimeout(async () => {
                    try {
                        // Check if TA exists in a different record (not the current one being updated)
                        const { data, error } = await supabase
                            .from("travel_authorities")
                            .select("id, ta_number")
                            .eq("ta_number", taNumber)
                            .maybeSingle();
                        
                        if (error && error.code !== 'PGRST116') {
                            // PGRST116 is "no rows returned" - that's expected if TA doesn't exist
                            console.error("Error checking TA number:", error);
                            return;
                        }
                        
                        // Only warn if TA exists AND it's a different record than the one being updated
                        if (data && updateRecordData && data.id !== updateRecordData.id) {
                            showToast(`TA ${taNumber} already exists in another record.`);
                        }
                    } catch (err) {
                        console.error("Error checking TA number:", err);
                    }
                }, 500);
            }
        });
        
        const recordCache = new Map();
        let viewRows = [];
        const currentYear = new Date().getFullYear().toString();
        let deleteRecordData = null;
        let updateRecordData = null;
        let toastTimer = null;
        let adminActiveFilters = {
            taNumber: "",
            employee: "",
            year: currentYear,
            travelDate: "",
            matchAll: false
        };
        let adminEmployeesListForFilter = [];
        window.adminEmployeesListForFilter = adminEmployeesListForFilter;

        const showToast = (message) => {
            if (!toast) return;
            toast.textContent = message;
            toast.classList.add("show");
            if (toastTimer) {
                clearTimeout(toastTimer);
            }
            toastTimer = setTimeout(() => {
                toast.classList.remove("show");
            }, 2600);
        };
        window.adminShowToast = showToast;

        // Show confirmation modal and return a Promise
        const showConfirmation = (title, message) => {
            return new Promise((resolve) => {
                confirmModalTitle.textContent = title;
                confirmModalMessage.textContent = message;
                confirmModal.classList.add("show");

                const handleConfirm = () => {
                    confirmModal.classList.remove("show");
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    confirmModal.classList.remove("show");
                    cleanup();
                    resolve(false);
                };

                const handleClickOutside = (e) => {
                    if (e.target === confirmModal) {
                        confirmModal.classList.remove("show");
                        cleanup();
                        resolve(false);
                    }
                };

                const cleanup = () => {
                    confirmConfirmBtn.removeEventListener('click', handleConfirm);
                    cancelConfirmBtn.removeEventListener('click', handleCancel);
                    confirmModal.removeEventListener('click', handleClickOutside);
                };

                confirmConfirmBtn.addEventListener('click', handleConfirm);
                cancelConfirmBtn.addEventListener('click', handleCancel);
                confirmModal.addEventListener('click', handleClickOutside);
            });
        };
        window.adminShowConfirmation = showConfirmation;

        window.flatpickr(updateTravelDateInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        window.flatpickr(updateTravelUntilInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        const applyAdminClientFilters = (rows) => {
            // If no filters are active, return all rows
            if (!adminActiveFilters.taNumber && !adminActiveFilters.employee && !adminActiveFilters.year && !adminActiveFilters.travelDate) {
                return rows;
            }

            return rows.filter(row => {
                const checks = [];

                // Check TA Number filter
                if (adminActiveFilters.taNumber) {
                    const matchesTa = row.ta_number && row.ta_number.toLowerCase().includes(adminActiveFilters.taNumber.toLowerCase());
                    checks.push(matchesTa);
                }

                // Check Employee filter (contains match for comma-separated values)
                if (adminActiveFilters.employee) {
                    const matchesEmployee = row.employees && row.employees.toLowerCase().includes(adminActiveFilters.employee.toLowerCase());
                    checks.push(matchesEmployee);
                }

                // Check Year filter
                if (adminActiveFilters.year) {
                    const matchesYear = row.travel_date && row.travel_date.startsWith(adminActiveFilters.year);
                    checks.push(matchesYear);
                }

                // Check Travel Date filter
                if (adminActiveFilters.travelDate) {
                    const matchesDate = row.travel_date && row.travel_date === adminActiveFilters.travelDate;
                    checks.push(matchesDate);
                }

                // Return based on match mode (AND or OR)
                if (adminActiveFilters.matchAll) {
                    // AND: all filters must match
                    return checks.every(check => check === true);
                } else {
                    // OR: at least one filter must match
                    return checks.some(check => check === true);
                }
            });
        };

        const renderViewRows = (rows) => {
            const filteredRows = applyAdminClientFilters(rows);
            
            if (!filteredRows.length) {
                recordCache.clear();
                viewBody.innerHTML = "<tr><td colspan=\"8\">No records match the current filters.</td></tr>";
                return;
            }

            recordCache.clear();
            filteredRows.forEach((row) => {
                recordCache.set(String(row.id), row);
            });

            viewBody.innerHTML = filteredRows.map((row) => {
                const dateText = row.travel_date ? new Date(row.travel_date).toLocaleDateString() : "-";
                const untilText = row.travel_until ? new Date(row.travel_until).toLocaleDateString() : "-";
                const fileUrl = row.file_url || "#";
                const safeName = row.file_name || "Download";
                const displayName = formatFileLabel(safeName);
                
                // Truncate employees to show max 2
                let employeesText = row.employees || "-";
                if (employeesText !== "-") {
                    const employeeArray = employeesText.split(",").map(e => e.trim());
                    if (employeeArray.length > 2) {
                        employeesText = employeeArray.slice(0, 2).join(", ") + "...";
                    }
                }

                return `
                    <tr data-id="${row.id}">
                        <td>
                            <button class="view-btn icon-btn" data-id="${row.id}" aria-label="View details">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M12 5c5 0 9.3 3 11 7-1.7 4-6 7-11 7S2.7 16 1 12c1.7-4 6-7 11-7Zm0 2C8.3 7 5 9.1 3.4 12 5 14.9 8.3 17 12 17s7-2.1 8.6-5C19 9.1 15.7 7 12 7Zm0 2.2a2.8 2.8 0 1 1 0 5.6 2.8 2.8 0 0 1 0-5.6Z" />
                                </svg>
                            </button>
                        </td>
                        <td>${row.ta_number || "-"}</td>
                        <td><span class="truncate">${row.purpose || "-"}</span></td>
                        <td style="text-align: left;"><span class="truncate">${row.destination || "-"}</span></td>
                        <td style="text-align: left;"><span class="truncate">${employeesText}</span></td>
                        <td>${dateText}</td>
                        <td>${untilText}</td>
                        <td>
                            <a class="file-link" href="${fileUrl}" target="_blank" rel="noopener">${displayName}</a>
                        </td>
                        <td class="actions-cell">
                            <button class="update-btn icon-btn" data-id="${row.id}" aria-label="Update" title="Update">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                                </svg>
                            </button>
                            <button class="delete-btn icon-btn" data-id="${row.id}" aria-label="Delete" title="Delete">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M9 3h6l1 2h4a1 1 0 1 1 0 2h-1l-1.1 12.1a2 2 0 0 1-2 1.9H8.1a2 2 0 0 1-2-1.9L5 7H4a1 1 0 0 1 0-2h4l1-2Zm1.1 7a1 1 0 1 0-2 0v7a1 1 0 1 0 2 0v-7Zm5.9 0a1 1 0 1 0-2 0v7a1 1 0 1 0 2 0v-7Z" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join("");

            // Add delete button event listeners
            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const row = e.target.closest("tr");
                    const recordId = (row?.getAttribute("data-id") || "").trim();
                    const record = recordCache.get(recordId);
                    deleteRecordData = {
                        id: recordId,
                        file_url: record?.file_url || ""
                    };
                    deleteModal.classList.add("show");
                });
            });

            document.querySelectorAll(".update-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const row = e.target.closest("tr");
                    if (!row) return;
                    const recordId = (row.getAttribute("data-id") || "").trim();
                    const record = recordCache.get(recordId);
                    if (!recordId || !record) return;

                    updateRecordData = {
                        id: recordId,
                        file_url: record.file_url || "",
                        file_name: record.file_name || "",
                        ta_number: record.ta_number || ""
                    };

                    updateTaInput.value = record.ta_number || "";
                    updatePurposeInput.value = record.purpose || "";
                    updateDestinationInput.value = record.destination || "";
                    updateTravelDateInput.value = record.travel_date || "";
                    updateTravelUntilInput.value = record.travel_until || "";
                    updateScanFileInput.value = "";
                    
                    // Populate employees multiselect
                    updateSelectedEmployees.length = 0;
                    if (record.employees) {
                        const employeeNames = record.employees.split(",").map(name => name.trim()).filter(name => name);
                        updateSelectedEmployees.push(...employeeNames);
                    }
                    updateEmployeesMultiSelect.updateDisplay();
                    updateEmployeesMultiSelect.renderOptions();
                    
                    updateStatus.textContent = "";
                    updateStatus.classList.remove("status--error");
                    updateStatus.classList.add("hidden");

                    updateModal.classList.add("show");
                });
            });

            document.querySelectorAll(".view-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const row = e.target.closest("tr");
                    if (!row) return;
                    const recordId = (row.getAttribute("data-id") || "").trim();
                    const record = recordCache.get(recordId);
                    if (!recordId || !record) return;

                    viewTaNumber.textContent = record.ta_number || "-";
                    viewPurpose.textContent = record.purpose || "-";
                    viewDestination.textContent = record.destination || "-";
                    viewEmployees.textContent = record.employees || "-";
                    viewTravelDate.textContent = record.travel_date
                        ? new Date(record.travel_date).toLocaleDateString()
                        : "-";
                    viewTravelUntil.textContent = record.travel_until
                        ? new Date(record.travel_until).toLocaleDateString()
                        : "-";

                    if (record.file_url) {
                        viewFileLink.href = record.file_url;
                        viewFileLink.textContent = record.file_name || "Open file";
                    } else {
                        viewFileLink.href = "#";
                        viewFileLink.textContent = "No file";
                    }

                    viewModal.classList.add("show");
                    document.getElementById("view-edit-btn")._currentRecordId = recordId;
                });
            });

            document.getElementById("view-edit-btn").addEventListener("click", () => {
                const recordId = document.getElementById("view-edit-btn")._currentRecordId;
                const record = recordCache.get(recordId);
                if (!recordId || !record) return;

                viewModal.classList.remove("show");

                updateRecordData = {
                    id: recordId,
                    file_url: record.file_url || "",
                    file_name: record.file_name || "",
                    ta_number: record.ta_number || ""
                };

                updateTaInput.value = record.ta_number || "";
                updatePurposeInput.value = record.purpose || "";
                updateDestinationInput.value = record.destination || "";
                updateTravelDateInput.value = record.travel_date || "";
                updateTravelUntilInput.value = record.travel_until || "";
                updateScanFileInput.value = "";

                updateSelectedEmployees.length = 0;
                if (record.employees) {
                    const employeeNames = record.employees.split(",").map(name => name.trim()).filter(name => name);
                    updateSelectedEmployees.push(...employeeNames);
                }
                updateEmployeesMultiSelect.updateDisplay();
                updateEmployeesMultiSelect.renderOptions();

                updateStatus.textContent = "";
                updateStatus.classList.remove("status--error");
                updateStatus.classList.add("hidden");

                updateModal.classList.add("show");
            });
        };

        const updateViewFooter = () => {
            const filteredCount = applyAdminClientFilters(viewRows).length;
            const hasActiveFilters = adminActiveFilters.taNumber || adminActiveFilters.employee || adminActiveFilters.year || adminActiveFilters.travelDate;
            
            if (!viewRows.length) {
                viewStatus.textContent = "No records yet.";
            } else if (hasActiveFilters) {
                viewStatus.textContent = `Showing ${filteredCount} of ${viewRows.length} record${viewRows.length === 1 ? "" : "s"} (filtered).`;
            } else {
                viewStatus.textContent = `Loaded ${viewRows.length} record${viewRows.length === 1 ? "" : "s"}.`;
            }
        };

        const loadTravelAuthorities = async (reset = false) => {
            if (reset) {
                viewRows = [];
                viewBody.innerHTML = "<tr><td colspan=\"8\">Loading records...</td></tr>";
            }

            viewStatus.textContent = "Fetching travel authorities.";
            try {
                const { data, error } = await supabase
                    .from("travel_authorities")
                    .select("id, ta_number, purpose, destination, employees, travel_date, travel_until, file_name, file_url, created_at")
                    .order("created_at", { ascending: false });

                if (error) {
                    throw error;
                }

                viewRows = data || [];
                renderViewRows(viewRows);
                updateViewFooter();
                await populateAdminYearFilter();
            } catch (error) {
                console.error("View load error:", error);
                viewBody.innerHTML = "<tr><td colspan=\"9\">Unable to load records.</td></tr>";
                viewStatus.textContent = "Failed to load travel authorities.";
            }
        };

        // Delete modal handlers
        cancelDeleteBtn.addEventListener("click", () => {
            deleteModal.classList.remove("show");
            deleteRecordData = null;
        });

        cancelUpdateBtn.addEventListener("click", () => {
            updateModal.classList.remove("show");
            updateRecordData = null;
        });

        // Hide load more button since we load all records now
        if (viewMoreBtn) {
            viewMoreBtn.style.display = 'none';
        }

        closeViewBtn.addEventListener("click", () => {
            viewModal.classList.remove("show");
        });

        // Admin filter panel functionality
        const adminFilterToggleBtn = document.getElementById("admin-filter-toggle-btn");
        const adminFilterPanel = document.getElementById("admin-filter-panel");
        const adminApplyFilterBtn = document.getElementById("admin-apply-filter-btn");
        const adminClearFilterBtn = document.getElementById("admin-clear-filter-btn");
        const adminFilterTaNumberInput = document.getElementById("admin-filter-ta-number");
        const adminFilterEmployeeSelect = document.getElementById("admin-filter-employee");
        const adminFilterYearSelect = document.getElementById("admin-filter-year");
        const adminFilterTravelDateInput = document.getElementById("admin-filter-travel-date");
        const adminFilterMatchAllCheckbox = document.getElementById("admin-filter-match-all");

        // Load employees for admin filter
        const loadAdminEmployeesForFilter = async () => {
            try {
                const { data, error } = await supabase
                    .from("employee_list")
                    .select("name, is_active")
                    .order("is_active", { ascending: false })
                    .order("name", { ascending: true });

                if (error) throw error;
                adminEmployeesListForFilter = data ? data : [];
                
                // Populate filter dropdown
                adminFilterEmployeeSelect.innerHTML = '<option value="">All Employees</option>' +
                    adminEmployeesListForFilter.map(emp => {
                        const inactiveLabel = emp.is_active === false ? ' (Inactive)' : '';
                        return `<option value="${emp.name}">${emp.name}${inactiveLabel}</option>`;
                    }).join('');
            } catch (error) {
                console.error("Failed to load employees for admin filter:", error);
                adminEmployeesListForFilter = [];
            }
        };

        // Populate year filter from available data
        const populateAdminYearFilter = async () => {
            try {
                // Get all unique years from database
                const { data, error } = await supabase
                    .from('travel_authorities')
                    .select('travel_date');
                    
                if (error) throw error;
                
                const years = new Set();
                data.forEach(row => {
                    if (row.travel_date) {
                        const year = row.travel_date.substring(0, 4);
                        if (year && year.length === 4) {
                            years.add(year);
                        }
                    }
                });
                
                const sortedYears = Array.from(years).sort((a, b) => b - a);
                adminFilterYearSelect.innerHTML = '<option value="">All Years</option>' +
                    sortedYears.map(year => `<option value="${year}"${year === currentYear ? ' selected' : ''}>${year}</option>`).join('');
            } catch (error) {
                console.error('Error populating year filter:', error);
            }
        };

        // Auto-dash formatting for TA Number filter
        const formatAdminTaNumber = (value) => {
            const digits = value.replace(/\D/g, "").slice(0, 10);
            const part1 = digits.slice(0, 4);
            const part2 = digits.slice(4, 6);
            const part3 = digits.slice(6, 10);
            if (digits.length <= 4) return part1;
            if (digits.length <= 6) return `${part1}-${part2}`;
            return `${part1}-${part2}-${part3}`;
        };

        adminFilterTaNumberInput.addEventListener("input", () => {
            adminFilterTaNumberInput.value = formatAdminTaNumber(adminFilterTaNumberInput.value);
        });

        // Initialize flatpickr for admin date filter
        window.flatpickr(adminFilterTravelDateInput, {
            dateFormat: "Y-m-d",
            allowInput: true,
            onChange: function(selectedDates, dateStr) {
                // Auto-sync year filter when date is selected
                if (dateStr && dateStr.length >= 4) {
                    const selectedYear = dateStr.substring(0, 4);
                    // Check if this year exists in the dropdown
                    const yearOption = Array.from(adminFilterYearSelect.options).find(opt => opt.value === selectedYear);
                    if (yearOption) {
                        adminFilterYearSelect.value = selectedYear;
                    } else {
                        // Year not available in records, set to "No selection"
                        adminFilterYearSelect.value = "";
                    }
                }
            }
        });

        adminFilterToggleBtn.addEventListener("click", () => {
            adminFilterPanel.classList.toggle("show");
        });

        adminApplyFilterBtn.addEventListener("click", () => {
            adminActiveFilters.taNumber = adminFilterTaNumberInput.value.trim();
            adminActiveFilters.employee = adminFilterEmployeeSelect.value;
            adminActiveFilters.year = adminFilterYearSelect.value;
            adminActiveFilters.travelDate = adminFilterTravelDateInput.value;
            adminActiveFilters.matchAll = adminFilterMatchAllCheckbox.checked;
            renderViewRows(viewRows);
            updateViewFooter();
            adminFilterPanel.classList.remove("show");
        });

        adminClearFilterBtn.addEventListener("click", () => {
            adminActiveFilters.taNumber = "";
            adminActiveFilters.employee = "";
            adminActiveFilters.year = "";
            adminActiveFilters.travelDate = "";
            adminActiveFilters.matchAll = false;
            adminFilterTaNumberInput.value = "";
            adminFilterEmployeeSelect.value = "";
            adminFilterYearSelect.value = "";
            adminFilterTravelDateInput.value = "";
            adminFilterMatchAllCheckbox.checked = false;
            renderViewRows(viewRows);
            updateViewFooter();
        });

        // Close admin filter panel when clicking outside
        document.addEventListener("click", (e) => {
            if (!adminFilterPanel.contains(e.target) && !adminFilterToggleBtn.contains(e.target) && adminFilterPanel.classList.contains("show")) {
                adminFilterPanel.classList.remove("show");
            }
        });

        // Export to Excel functionality
        const exportModal = document.getElementById("export-modal");
        const exportBtn = document.getElementById("admin-export-btn");
        const cancelExportBtn = document.getElementById("cancel-export");
        const confirmExportBtn = document.getElementById("confirm-export");
        const exportAllYearsCheckbox = document.getElementById("export-all-years");
        const exportYearsList = document.getElementById("export-years-list");
        const exportStatus = document.getElementById("export-status");

        let availableYearsForExport = [];

        // Populate export years from available data
        const populateExportYears = async () => {
            try {
                const { data, error } = await supabase
                    .from('travel_authorities')
                    .select('travel_date');

                if (error) throw error;

                const yearsSet = new Set();
                data.forEach(record => {
                    if (record.travel_date) {
                        const year = new Date(record.travel_date).getFullYear();
                        yearsSet.add(year);
                    }
                });

                availableYearsForExport = Array.from(yearsSet).sort((a, b) => b - a);

                // Populate checkboxes
                exportYearsList.innerHTML = availableYearsForExport.map(year => `
                    <label class="checkbox-label">
                        <input type="checkbox" class="export-year-checkbox" value="${year}">
                        <span>${year}</span>
                    </label>
                `).join('');

            } catch (error) {
                console.error('Error populating export years:', error);
            }
        };

        exportBtn.addEventListener("click", async () => {
            await populateExportYears();
            exportModal.classList.add("show");
            exportStatus.classList.add("hidden");
            exportStatus.classList.remove("status--error");
        });

        cancelExportBtn.addEventListener("click", () => {
            exportModal.classList.remove("show");
            exportAllYearsCheckbox.checked = false;
            const yearCheckboxes = document.querySelectorAll(".export-year-checkbox");
            yearCheckboxes.forEach(cb => cb.checked = false);
        });

        exportAllYearsCheckbox.addEventListener("change", (e) => {
            const yearCheckboxes = document.querySelectorAll(".export-year-checkbox");
            yearCheckboxes.forEach(cb => cb.checked = e.target.checked);
        });

        confirmExportBtn.addEventListener("click", async () => {
            try {
                exportStatus.textContent = "Preparing export...";
                exportStatus.classList.remove("hidden", "status--error");

                // Get selected years
                const selectedYears = [];
                if (exportAllYearsCheckbox.checked) {
                    selectedYears.push(...availableYearsForExport);
                } else {
                    const yearCheckboxes = document.querySelectorAll(".export-year-checkbox:checked");
                    yearCheckboxes.forEach(cb => selectedYears.push(parseInt(cb.value)));
                }

                if (selectedYears.length === 0) {
                    exportStatus.textContent = "Please select at least one year to export.";
                    exportStatus.classList.add("status--error");
                    return;
                }

                exportStatus.textContent = "Fetching records...";

                // Fetch all records
                const { data, error } = await supabase
                    .from("travel_authorities")
                    .select("ta_number, purpose, destination, employees, travel_date, travel_until")
                    .order("travel_date", { ascending: false });

                if (error) throw error;

                // Filter by selected years
                const filteredData = data.filter(record => {
                    if (!record.travel_date) return false;
                    const year = new Date(record.travel_date).getFullYear();
                    return selectedYears.includes(year);
                });

                if (filteredData.length === 0) {
                    exportStatus.textContent = "No records found for selected years.";
                    exportStatus.classList.add("status--error");
                    return;
                }

                exportStatus.textContent = "Generating Excel file...";

                // Prepare data for export
                const exportData = filteredData.map(record => ({
                    "TA Number": record.ta_number || "",
                    "Purpose": record.purpose || "",
                    "Destination": record.destination || "",
                    "Employees": Array.isArray(record.employees) ? record.employees.join(", ") : record.employees || "",
                    "Travel Date": record.travel_date || "",
                    "Travel End": record.travel_until || ""
                }));

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);

                // Set column widths
                ws['!cols'] = [
                    { wch: 15 },  // TA Number
                    { wch: 30 },  // Purpose
                    { wch: 20 },  // Destination
                    { wch: 30 },  // Employees
                    { wch: 12 },  // Travel Date
                    { wch: 12 }   // Travel End
                ];

                XLSX.utils.book_append_sheet(wb, ws, "Travel Authorities");

                // Generate filename with selected years
                const yearRange = selectedYears.length === availableYearsForExport.length ? 
                    "All_Years" : 
                    selectedYears.sort().join("_");
                const filename = `Travel_Authorities_${yearRange}_${new Date().toISOString().split('T')[0]}.xlsx`;

                // Download file
                XLSX.writeFile(wb, filename);

                exportStatus.textContent = `Successfully exported ${filteredData.length} records!`;
                
                // Close modal after 2 seconds
                setTimeout(() => {
                    exportModal.classList.remove("show");
                    exportAllYearsCheckbox.checked = false;
                    const yearCheckboxes = document.querySelectorAll(".export-year-checkbox");
                    yearCheckboxes.forEach(cb => cb.checked = false);
                }, 2000);

            } catch (error) {
                console.error("Export error:", error);
                exportStatus.textContent = `Export failed: ${error.message || "Unknown error"}`;
                exportStatus.classList.add("status--error");
            }
        });

        confirmDeleteBtn.addEventListener("click", async () => {
            if (!deleteRecordData || !deleteRecordData.id) return;

            try {
                viewStatus.textContent = "Deleting record...";
                
                // Delete database record first
                const { error: deleteError } = await supabase
                    .from("travel_authorities")
                    .delete()
                    .eq("id", deleteRecordData.id);

                if (deleteError) {
                    throw deleteError;
                }

                // Extract file path from URL and delete from storage
                if (deleteRecordData.file_url) {
                    try {
                        const url = new URL(deleteRecordData.file_url);
                        const pathParts = url.pathname.split('/ta-files/');
                        if (pathParts.length > 1) {
                            const filePath = decodeURIComponent(pathParts[1]);
                            
                            const { error: storageError } = await supabase
                                .storage
                                .from("ta-files")
                                .remove([filePath]);

                            if (storageError) {
                                console.warn("Storage delete warning:", storageError);
                            }
                        }
                    } catch (urlError) {
                        console.warn("File path extraction error:", urlError);
                    }
                }

                deleteModal.classList.remove("show");
                viewStatus.textContent = "Record deleted successfully.";
                deleteRecordData = null;
                
                // Reload the table
                await loadTravelAuthorities(true);
            } catch (error) {
                console.error("Delete error:", error);
                viewStatus.textContent = `Delete failed: ${error.message || "Unknown error"}`;
                deleteModal.classList.remove("show");
                deleteRecordData = null;
            }
        });

        confirmUpdateBtn.addEventListener("click", async () => {
            if (!updateRecordData || !updateRecordData.id) return;

            const taNumber = updateTaInput.value.trim();
            const purpose = updatePurposeInput.value.trim();
            const destination = updateDestinationInput.value.trim();
            const travelDate = updateTravelDateInput.value;
            let travelUntil = updateTravelUntilInput.value;
            const employees = updateSelectedEmployees.join(", ");
            const file = updateScanFileInput.files[0];

            if (!taNumber || !purpose || !destination || !travelDate || updateSelectedEmployees.length === 0) {
                updateStatus.textContent = "Please fill in all required fields.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake", "hidden");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            if (!isValidTaNumber(taNumber)) {
                updateStatus.textContent = "TA Number must be in the format 0000-00-0000.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake", "hidden");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            // Check if TA number already exists in another record
            try {
                const { data: existingRecord, error: checkError } = await supabase
                    .from("travel_authorities")
                    .select("id, ta_number")
                    .eq("ta_number", taNumber)
                    .maybeSingle();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    console.error("Error checking TA number:", checkError);
                    throw new Error("Failed to verify TA number. Please try again.");
                }
                
                // If TA exists and it's NOT the current record being updated, block the update
                if (existingRecord && existingRecord.id !== updateRecordData.id) {
                    updateStatus.textContent = `TA Number ${taNumber} already exists in another record.`;
                    updateStatus.classList.add("status--error");
                    updateStatus.classList.remove("status--shake", "hidden");
                    void updateStatus.offsetWidth;
                    updateStatus.classList.add("status--shake");
                    return;
                }
            } catch (error) {
                console.error("TA validation error:", error);
                updateStatus.textContent = error.message || "Failed to validate TA number.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake", "hidden");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            if (!travelUntil) {
                travelUntil = travelDate;
                updateTravelUntilInput.value = travelDate;
            }

            const start = new Date(`${travelDate}T00:00:00`);
            const end = new Date(`${travelUntil}T00:00:00`);
            if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
                updateStatus.textContent = "Please enter valid dates.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake", "hidden");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            if (start > end) {
                updateStatus.textContent = "Travel date cannot be after travel end.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake", "hidden");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            try {
                updateStatus.textContent = "Updating record...";
                updateStatus.classList.remove("status--error", "hidden");

                let fileUrl = updateRecordData.file_url || "";
                let fileName = updateRecordData.file_name || "";
                // Ensure both values are formatted consistently before comparing
                const taNumberChanged = formatTaNumber(taNumber) !== formatTaNumber(updateRecordData.ta_number);

                if (file) {
                    // Show initial file size
                    const originalSizeMB = (file.size / 1024 / 1024).toFixed(2);
                    updateStatus.textContent = `File: ${originalSizeMB}MB - Compressing...`;
                    
                    // Compress PDF before uploading
                    const processedFile = await compressPDF(file);
                    const compressedSizeMB = (processedFile.size / 1024 / 1024).toFixed(2);
                    
                    // Check if compressed file is still too large
                    const maxAllowedMB = 5;
                    if (processedFile.size > maxAllowedMB * 1024 * 1024) {
                        updateStatus.textContent = `File too large: ${compressedSizeMB}MB (max ${maxAllowedMB}MB). Please use a smaller PDF.`;
                        updateStatus.classList.add("status--error");
                        updateStatus.classList.remove("status--shake");
                        void updateStatus.offsetWidth;
                        updateStatus.classList.add("status--shake");
                        return;
                    }

                    updateStatus.textContent = `Uploading ${compressedSizeMB}MB...`;

                    const safeTa = taNumber.replace(/[^a-z0-9-_]/gi, "_");
                    const safeDate = travelDate.replace(/[^0-9-]/g, "-");
                    
                    // Extract file extension and rename file to TA number
                    const fileExtension = processedFile.name.substring(processedFile.name.lastIndexOf('.'));
                    const newFileName = `${taNumber}${fileExtension}`;
                    const filePath = `travel-authorities/${safeTa}/${safeDate}/${newFileName}`;

                    const { error: uploadError } = await supabase
                        .storage
                        .from("ta-files")
                        .upload(filePath, processedFile, { upsert: false });

                    if (uploadError) {
                        throw new Error(`Storage upload failed: ${uploadError.message || "Unknown error"}`);
                    }

                    const { data: publicUrlData } = supabase
                        .storage
                        .from("ta-files")
                        .getPublicUrl(filePath);

                    fileUrl = publicUrlData.publicUrl;
                    fileName = newFileName;
                } else if (taNumberChanged && updateRecordData.file_url) {
                    // TA number changed but no new file uploaded - rename existing file
                    updateStatus.textContent = "Renaming file to match new TA number...";
                    
                    try {
                        const url = new URL(updateRecordData.file_url);
                        const pathParts = url.pathname.split('/ta-files/');
                        if (pathParts.length > 1) {
                            const oldFilePath = decodeURIComponent(pathParts[1]);
                            
                            // Download the old file
                            const { data: fileData, error: downloadError } = await supabase
                                .storage
                                .from("ta-files")
                                .download(oldFilePath);
                            
                            if (downloadError) {
                                console.warn("Could not download old file for renaming:", downloadError);
                            } else {
                                // Upload with new TA number name
                                const safeTa = taNumber.replace(/[^a-z0-9-_]/gi, "_");
                                const safeDate = travelDate.replace(/[^0-9-]/g, "-");
                                const fileExtension = updateRecordData.file_name.substring(updateRecordData.file_name.lastIndexOf('.'));
                                const newFileName = `${taNumber}${fileExtension}`;
                                const newFilePath = `travel-authorities/${safeTa}/${safeDate}/${newFileName}`;
                                
                                const { error: uploadError } = await supabase
                                    .storage
                                    .from("ta-files")
                                    .upload(newFilePath, fileData, { upsert: false });
                                
                                if (uploadError) {
                                    console.warn("Could not upload renamed file:", uploadError);
                                } else {
                                    // Get new public URL
                                    const { data: publicUrlData } = supabase
                                        .storage
                                        .from("ta-files")
                                        .getPublicUrl(newFilePath);
                                    
                                    fileUrl = publicUrlData.publicUrl;
                                    fileName = newFileName;
                                    
                                    // Delete old file
                                    const { error: deleteError } = await supabase
                                        .storage
                                        .from("ta-files")
                                        .remove([oldFilePath]);
                                    
                                    if (deleteError) {
                                        console.warn("Could not delete old file after rename:", deleteError);
                                    }
                                }
                            }
                        }
                    } catch (renameError) {
                        console.warn("Error renaming file:", renameError);
                        // Continue with update even if rename fails
                    }
                }

                const { error: updateError } = await supabase
                    .from("travel_authorities")
                    .update({
                        ta_number: taNumber,
                        purpose: purpose,
                        destination: destination,
                        employees: employees,
                        travel_date: travelDate,
                        travel_until: travelUntil,
                        file_name: fileName,
                        file_url: fileUrl
                    })
                    .eq("id", updateRecordData.id);

                if (updateError) {
                    // Check for duplicate TA number error
                    if (updateError.code === '23505' || updateError.message?.includes('duplicate key') || updateError.message?.includes('unique constraint')) {
                        throw new Error(`TA Number ${taNumber} already exists in the database.`);
                    }
                    throw new Error(`Database update failed: ${updateError.message || "Unknown error"}`);
                }

                if (file && updateRecordData.file_url) {
                    try {
                        const url = new URL(updateRecordData.file_url);
                        const pathParts = url.pathname.split('/ta-files/');
                        if (pathParts.length > 1) {
                            const oldFilePath = decodeURIComponent(pathParts[1]);

                            const { error: storageError } = await supabase
                                .storage
                                .from("ta-files")
                                .remove([oldFilePath]);

                            if (storageError) {
                                console.warn("Storage delete warning:", storageError);
                            }
                        }
                    } catch (urlError) {
                        console.warn("File path extraction error:", urlError);
                    }
                }

                updateModal.classList.remove("show");
                updateRecordData = null;
                viewStatus.textContent = "Record updated successfully.";
                showToast("Update saved.");
                await loadTravelAuthorities(true);
            } catch (error) {
                console.error("Update error:", error);
                const message = error && error.message ? error.message : "Please try again.";
                updateStatus.textContent = `Update failed: ${message}`;
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake", "hidden");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
            }
        });

        // Close modal when clicking outside
        deleteModal.addEventListener("click", (e) => {
            if (e.target === deleteModal) {
                deleteModal.classList.remove("show");
                deleteRecordData = null;
            }
        });

        updateModal.addEventListener("click", (e) => {
            if (e.target === updateModal) {
                updateModal.classList.remove("show");
                updateRecordData = null;
            }
        });

        viewModal.addEventListener("click", (e) => {
            if (e.target === viewModal) {
                viewModal.classList.remove("show");
            }
        });

        // Auto-clear checkbox state management
        const autoClearCheckbox = document.getElementById("auto-clear-checkbox");
        
        // Load saved state from localStorage
        const savedAutoClearState = localStorage.getItem("autoClearFields");
        if (savedAutoClearState === "true") {
            autoClearCheckbox.checked = true;
        }
        
        // Save state when checkbox changes
        autoClearCheckbox.addEventListener("change", () => {
            localStorage.setItem("autoClearFields", autoClearCheckbox.checked.toString());
        });

        // ============================================
        // EMPLOYEE MANAGEMENT
        // ============================================
        // Employee management is loaded from employees/employees.js

        // ============================================
        // USER MANAGEMENT (SUPER USER ONLY)
        // ============================================
        
        // Note: User panel elements are loaded asynchronously from users/users-panel.html
        // They are queried dynamically in the functions below
        
        let allUsersData = []; // Store all users for filtering

        const getRolePriority = (role) => {
            const priorities = { 'super': 3, 'admin': 2, 'user': 1 };
            return priorities[role] || 0;
        };

        const truncateEmail = (email, maxLocalLength = 10) => {
            if (!email || !email.includes('@')) return email;
            
            const [localPart, domain] = email.split('@');
            
            if (localPart.length <= maxLocalLength) {
                return email; // No truncation needed
            }
            
            // Truncate local part but keep domain
            const truncated = localPart.substring(0, maxLocalLength) + '...';
            return `${truncated}@${domain}`;
        };

        const renderUsersTable = (users) => {
            const usersBody = document.getElementById('users-body');
            const usersStatus = document.getElementById('users-status');
            
            if (!usersBody || !usersStatus) {
                console.warn('Users panel elements not found in DOM yet');
                return;
            }
            
            if (!users || users.length === 0) {
                usersBody.innerHTML = '<tr><td colspan="5">No users found.</td></tr>';
                usersStatus.textContent = 'No users available.';
                return;
            }

            // Render users table
            usersBody.innerHTML = users.map(user => {
                const accessEnabled = user.access_enabled !== false;
                const displayEmail = truncateEmail(user.email || 'No email', 10);
                const fullEmail = user.email || 'No email';
                const isOnline = user.is_online === true;
                const statusClass = isOnline ? 'status-online' : 'status-offline';
                const statusText = isOnline ? 'Online' : 'Offline';
                return `
                <tr class="${!accessEnabled ? 'user-disabled' : ''}">
                    <td class="text-left" title="${fullEmail}">${displayEmail}</td>
                    <td><span class="status-indicator ${statusClass}">${statusText}</span></td>
                    <td>
                        <select class="access-select" data-user-id="${user.id}" data-current-access="${accessEnabled}">
                            <option value="true" ${accessEnabled ? 'selected' : ''}>Enabled</option>
                            <option value="false" ${!accessEnabled ? 'selected' : ''}>Disabled</option>
                        </select>
                    </td>
                    <td>
                        <select class="role-select" data-user-id="${user.id}" data-current-role="${user.role}" ${!accessEnabled ? 'disabled' : ''}>
                            <option value="">-- Select Role --</option>
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            <option value="super" ${user.role === 'super' ? 'selected' : ''}>Super</option>
                        </select>
                    </td>
                </tr>
            `;
            }).join('');

            // Add change event listeners to role selects
            document.querySelectorAll('.role-select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    const userId = e.target.getAttribute('data-user-id');
                    const currentRole = e.target.getAttribute('data-current-role');
                    const newRole = e.target.value;

                    if (!newRole || newRole === currentRole) {
                        e.target.value = currentRole; // Reset if no selection or same role
                        return;
                    }

                    // Confirm role change
                    const confirmChange = await showConfirmation(
                        'Confirm Role Change',
                        `Change user role from "${currentRole}" to "${newRole}"?`
                    );
                    if (!confirmChange) {
                        e.target.value = currentRole; // Reset to original
                        return;
                    }

                    await changeUserRole(userId, newRole, e.target);
                });
            });

            // Add change event listeners to access selects
            document.querySelectorAll('.access-select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    const userId = e.target.getAttribute('data-user-id');
                    const currentAccess = e.target.getAttribute('data-current-access') === 'true';
                    const newAccess = e.target.value === 'true';
                    
                    if (newAccess === currentAccess) {
                        return; // No change
                    }
                    
                    // Confirm access change
                    const action = newAccess ? 'enable' : 'disable';
                    const confirmChange = await showConfirmation(
                        'Confirm Access Change',
                        `Are you sure you want to ${action} access for this user?`
                    );
                    if (!confirmChange) {
                        e.target.value = currentAccess.toString(); // Reset to original
                        return;
                    }

                    await toggleUserAccess(userId, newAccess, e.target);
                });
            });

            // Query filter element to check if we're in filtered mode
            const usersRoleFilter = document.getElementById('users-role-filter');
            const filterValue = usersRoleFilter?.value || '';
            const displayCount = filterValue ? users.length : allUsersData.length;
            const filterText = filterValue ? ` (filtered by ${filterValue})` : '';
            usersStatus.textContent = `Loaded ${displayCount} user(s)${filterText}.`;
        };

        const loadUsers = async () => {
            const usersBody = document.getElementById('users-body');
            const usersStatus = document.getElementById('users-status');
            
            if (!usersBody || !usersStatus) {
                console.error('Users panel elements not found in DOM');
                return;
            }
            
            try {
                usersStatus.textContent = 'Loading users...';
                usersStatus.classList.remove('status--error');
                // Use RPC function to get users with emails from auth.users
                // This is secure because the RPC function validates super user permission
                const { data, error } = await supabase.rpc('get_all_users_with_emails');
                if (error) {
                    console.error('Error loading users:', error);
                    console.error('Error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    // Provide helpful error messages
                    if (error.message.includes('function') && error.message.includes('does not exist')) {
                        throw new Error('Database function not found. Please run the SQL script: create_get_users_function.sql');
                    } else if (error.message.includes('Permission denied')) {
                        throw new Error('Permission denied. Only super users can view all users.');
                    } else {
                        throw error;
                    }
                }
                if (!data || data.length === 0) {
                    allUsersData = [];
                    renderUsersTable([]);
                    return;
                }
                // Sort by role priority: super > admin > user
                allUsersData = data.sort((a, b) => {
                    const priorityDiff = getRolePriority(b.role) - getRolePriority(a.role);
                    if (priorityDiff !== 0) return priorityDiff;
                    // If same role, sort by email
                    return (a.email || '').localeCompare(b.email || '');
                });
                renderUsersTable(allUsersData);
                // Attach filter listeners after table is rendered
                const usersRoleFilter = document.getElementById('users-role-filter');
                const usersAccessFilter = document.getElementById('users-access-filter');
                const usersStatusFilter = document.getElementById('users-status-filter');

                const filterUsers = () => {
                    let filtered = allUsersData;
                    const role = usersRoleFilter.value;
                    const access = usersAccessFilter.value;
                    const status = usersStatusFilter.value;
                    if (role) {
                        filtered = filtered.filter(u => u.role === role);
                    }
                    if (access) {
                        filtered = filtered.filter(u => {
                            if (access === 'enabled') return u.access_enabled === true;
                            if (access === 'disabled') return u.access_enabled === false;
                            return true;
                        });
                    }
                    if (status) {
                        filtered = filtered.filter(u => {
                            if (status === 'online') return u.is_online === true;
                            if (status === 'offline') return u.is_online === false;
                            return true;
                        });
                    }
                    renderUsersTable(filtered);
                };

                usersRoleFilter.onchange = filterUsers;
                usersAccessFilter.onchange = filterUsers;
                usersStatusFilter.onchange = filterUsers;
            
                // Clear all filters button
                const clearFiltersBtn = document.getElementById('clear-filters-btn');
                if (clearFiltersBtn) {
                    clearFiltersBtn.addEventListener('click', () => {
                        usersRoleFilter.value = '';
                        usersAccessFilter.value = '';
                        usersStatusFilter.value = '';
                        filterUsers();
                    });
                }
            
                // Also filter on load if any filter is set
                filterUsers();
            } catch (error) {
                console.error('Failed to load users:', error);
                const usersBody = document.getElementById('users-body');
                const usersStatus = document.getElementById('users-status');
                if (usersBody) {
                    usersBody.innerHTML = '<tr><td colspan="5">Error loading users.</td></tr>';
                }
                if (usersStatus) {
                    usersStatus.textContent = 'Failed to load users.';
                }
            }
        };

        const changeUserRole = async (userId, newRole, selectElement) => {
            const originalRole = selectElement.getAttribute('data-current-role');
            const usersStatus = document.getElementById('users-status');
            
            try {
                if (usersStatus) {
                    usersStatus.textContent = 'Changing user role...';
                    usersStatus.classList.remove('status--error');
                }

                // Get current logged-in user ID
                const { data: sessionData } = await supabase.auth.getSession();
                const currentUserId = sessionData?.session?.user?.id;
                const isChangingOwnRole = userId === currentUserId;

                // Call server-side RPC function that validates permissions
                // CRITICAL: This RPC function MUST verify that the calling user is 'super'
                const { data, error } = await supabase.rpc('change_user_role', {
                    target_user_id: userId,
                    new_role: newRole
                });

                if (error) {
                    throw error;
                }

                // Update success
                selectElement.setAttribute('data-current-role', newRole);
                if (usersStatus) {
                    usersStatus.textContent = 'Role updated successfully';
                }
                showToast(`Role changed to ${newRole}`);
                
                // If user changed their own role, logout after showing success message
                if (isChangingOwnRole) {
                    setTimeout(async () => {
                        showToast('Your role has changed. Logging out...');
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        localStorage.removeItem('admin_session_token');
                        localStorage.removeItem('adminActivePanel');
                        await supabase.auth.signOut();
                        window.location.href = '../index.html';
                    }, 1000);
                    return;
                }
                
                // Reload users to refresh the display
                await loadUsers();

            } catch (error) {
                console.error('Failed to change user role:', error);
                
                // Revert select to original role
                selectElement.value = originalRole;
                
                // Show user-friendly error message
                let errorMessage = 'Failed to change role';
                
                if (error.hint) {
                    errorMessage = error.hint;
                } else if (error.message) {
                    if (error.message.includes('last super user')) {
                        errorMessage = 'You are the last super user. There must be at least one super user.';
                    } else if (error.message.includes('Permission denied')) {
                        errorMessage = 'Permission denied. Only super users can change roles.';
                    } else if (error.message.includes('Invalid role')) {
                        errorMessage = 'Invalid role selected.';
                    } else if (error.message.includes('User not found')) {
                        errorMessage = 'User not found.';
                    } else {
                        errorMessage = error.message;
                    }
                }
                
                const usersStatus = document.getElementById('users-status');
                if (usersStatus) {
                    usersStatus.textContent = errorMessage;
                    usersStatus.classList.add('status--error');
                }
                showToast(errorMessage);
            }
        };

        const toggleUserAccess = async (userId, newAccessEnabled, selectElement) => {
            const originalAccess = selectElement.getAttribute('data-current-access') === 'true';
            const usersStatus = document.getElementById('users-status');
            
            try {
                if (usersStatus) {
                    usersStatus.textContent = `${newAccessEnabled ? 'Enabling' : 'Disabling'} user access...`;
                    usersStatus.classList.remove('status--error');
                }

                // Call server-side RPC function that validates permissions
                // CRITICAL: This RPC function MUST verify that the calling user is 'super'
                const { data, error } = await supabase.rpc('toggle_user_access', {
                    target_user_id: userId,
                    new_access_enabled: newAccessEnabled
                });

                if (error) {
                    throw error;
                }

                // Update success
                const action = newAccessEnabled ? 'enabled' : 'disabled';
                if (usersStatus) {
                    usersStatus.textContent = 'Access updated successfully';
                }
                showToast(`Access ${action}`);
                
                // Reload users to refresh the display
                await loadUsers();

            } catch (error) {
                console.error('Failed to toggle user access:', error);
                
                // Revert select to original value
                selectElement.value = originalAccess.toString();
                
                // Show user-friendly error message
                let errorMessage = 'Failed to change access';
                
                if (error.hint) {
                    errorMessage = error.hint;
                } else if (error.message) {
                    if (error.message.includes('last super user')) {
                        errorMessage = 'You are the last super user. There must be at least one super user with access.';
                    } else if (error.message.includes('Cannot disable your own access')) {
                        errorMessage = 'You cannot disable your own access.';
                    } else if (error.message.includes('Permission denied')) {
                        errorMessage = 'Permission denied. Only super users can change access.';
                    } else if (error.message.includes('User not found')) {
                        errorMessage = 'User not found.';
                    } else {
                        errorMessage = error.message;
                    }
                }
                
                const usersStatus = document.getElementById('users-status');
                if (usersStatus) {
                    usersStatus.textContent = errorMessage;
                    usersStatus.classList.add('status--error');
                }
                showToast(errorMessage);
            }
        };

        // ============================================
        // END USER MANAGEMENT
        // ============================================

        // Initialize and check permissions
        (async () => {
            const userRole = await requireAdmin();
            if (!userRole) return; // Redirected to login or dashboard
            
            // Start global heartbeat for current user (runs on all panels)
            const updateHeartbeat = async () => {
                try {
                    const { data, error } = await supabase.rpc('update_last_seen');
                    if (error) {
                        console.warn('Heartbeat error:', error.message);
                    } else {
                        // Heartbeat updated
                    }
                } catch (error) {
                    // Heartbeat update skipped
                }
            };
            
            // Update immediately and then every 15 seconds
            updateHeartbeat();
            setInterval(updateHeartbeat, 15000);
            
            // Show User Management panel only for super users
            if (userRole === 'super') {
                // Wait for users panel to load before setting up
                usersPanelLoaded.then(async () => {
                    const usersPanelBtn = document.getElementById('users-panel-btn');
                    if (usersPanelBtn) {
                        usersPanelBtn.classList.remove('hidden');
                        // Restore users-panel if it was the last active panel
                        if (localStorage.getItem('adminActivePanel') === 'users-panel') {
                            usersPanelBtn.click();
                        }
                    }
                    // Load users for the User Management panel
                    await loadUsers();
                    
                    // Start auto-refresh for user management panel (every 10 seconds)
                    let userRefreshInterval = null;
                    
                    // Set up interval to refresh users table when panel is visible
                    const startUserRefresh = () => {
                        if (userRefreshInterval) return; // Already running
                        
                        userRefreshInterval = setInterval(async () => {
                            // Only refresh if users panel is visible
                            const usersPanel = document.getElementById('users-panel');
                            if (usersPanel && !usersPanel.classList.contains('hidden')) {
                                await loadUsers();
                            }
                        }, 10000); // 10 seconds
                    };
                    
                    const stopUserRefresh = () => {
                        if (userRefreshInterval) {
                            clearInterval(userRefreshInterval);
                            userRefreshInterval = null;
                        }
                    };
                    
                    // Monitor panel visibility
                    const panelSwitchers = document.querySelectorAll('.switch-btn');
                    panelSwitchers.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const targetPanel = btn.getAttribute('data-panel');
                            if (targetPanel === 'users-panel') {
                                startUserRefresh();
                            } else {
                                stopUserRefresh();
                            }
                        });
                    });
                    
                    // Start if users panel is initially visible
                    const usersPanel = document.getElementById('users-panel');
                    if (usersPanel && !usersPanel.classList.contains('hidden')) {
                        startUserRefresh();
                    }
                });
            }
        })();
        
        loadEmployees();
        loadAdminEmployeesForFilter();

        // Restore last active panel (wait for panels to load first)
        Promise.all([employeePanelLoaded, usersPanelLoaded]).then(() => {
            const savedPanel = localStorage.getItem("adminActivePanel");
            if (!savedPanel || savedPanel === "upload-panel" || savedPanel === "users-panel") return;
            const targetBtn = document.querySelector(`.switch-btn[data-panel="${savedPanel}"]`);
            if (!targetBtn || targetBtn.classList.contains("hidden")) return;
            targetBtn.click();
        });

        // Prevent browser back/forward navigation
        // This prevents users from accidentally navigating back to login or other pages
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', () => {
            history.pushState(null, null, location.href);
        });

        // Force page reload if loaded from cache (back/forward button)
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                window.location.reload();
            }
        });

        // Initialize header buttons after everything is defined
        if (window.headerLoaded) {
            window.initHeaderButtons();
        }

        document.getElementById('close-settings').addEventListener('click', () => {
            document.getElementById('settings-modal').classList.remove('show');
        });

        document.getElementById('settings-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('settings-modal')) {
                document.getElementById('settings-modal').classList.remove('show');
            }
        });
    </script>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h3>Settings</h3>
            <p>Settings functionality will be available soon.</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="close-settings">Close</button>
            </div>
        </div>
    </div>

    <div id="footer-container"></div>
    <script>
        fetch('../footer/footer.html')
            .then(response => response.text())
            .then(data => {
                const footerHTML = data.replace(/FOOTER_ASSETS_PATH/g, '../assets');
                document.getElementById('footer-container').innerHTML = footerHTML;
            })
            .catch(error => console.error('Error loading footer:', error));
    </script>

</body>
</html>
