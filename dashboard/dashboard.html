<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHEDRO IV TA - Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../footer/footer.css">
</head>
<body>
    <header class="header">
        <h1>Welcome</h1>
            <p class="welcome-message">You are logged in as a regular user. You have access to view and download documents.<br>For not yet available Travel Authority, you may request from Ms. Emmalyn for an early copy.</p>
        <button id="logout-btn" type="button" class="logout-btn">Log Out</button>
    </header>
    <main class="shell">
        <section class="panel wide-panel" id="ta-panel">
            <div class="panel-head">
                <h2>Travel Authorities</h2>
                <div class="panel-head-actions">
                    <button id="filter-toggle-btn" class="filter-icon-btn" type="button" aria-label="Toggle filters" title="Filter">
                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                        </svg>
                    </button>
                    <span class="pill">Read only</span>
                </div>
            </div>
            <div id="filter-panel" class="filter-panel">
                <div class="filter-content">
                    <h3>Filter Options</h3>
                    <div class="filter-mode">
                        <label class="checkbox-label">
                            <input type="checkbox" id="filter-match-all">
                            <span>Match all filters (AND)</span>
                        </label>
                        <p class="filter-mode-note">Unchecked: Match any filter (OR)</p>
                    </div>
                    <div class="filter-fields">
                        <div class="filter-field">
                            <label for="filter-ta-number">TA Number</label>
                            <input type="text" id="filter-ta-number" placeholder="0000-00-0000" maxlength="12">
                        </div>
                        <div class="filter-field">
                            <label for="filter-employee">Employee</label>
                            <select id="filter-employee" class="filter-select">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        <div class="filter-field">
                            <label for="filter-travel-date">Travel Date</label>
                            <input type="text" id="filter-travel-date" placeholder="Select date">
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button id="apply-filter-btn" class="filter-btn apply-btn" type="button">Apply Filter</button>
                        <button id="clear-filter-btn" class="filter-btn clear-btn" type="button">Clear Filter</button>
                    </div>
                </div>
            </div>
            <div class="table-wrap max-rows-10">
                <table class="data-table" aria-describedby="ta-status">
                    <thead>
                        <tr>
                            <th scope="col">View</th>
                            <th scope="col">TA Number</th>
                            <th scope="col">Purpose</th>
                            <th scope="col">Destination</th>
                            <th scope="col">Employees</th>
                            <th scope="col">Travel Date</th>
                            <th scope="col">Travel End</th>
                            <th scope="col">File</th>
                        </tr>
                    </thead>
                    <tbody id="ta-body">
                        <tr>
                            <td colspan="8">Loading records...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="table-footer">
                <span class="status" id="ta-status">Fetching travel authorities.</span>
                <button id="ta-more" class="pagination-btn" type="button">Load more</button>
            </div>
        </section>
    </main>

    <div id="view-modal" class="modal">
        <div class="modal-content modal-form">
            <h3>Travel Authority Details</h3>
            <div class="detail-list">
                <div class="detail-row">
                    <span class="detail-label">TA Number</span>
                    <span class="detail-value" id="view-ta-number">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Purpose</span>
                    <span class="detail-value" id="view-purpose">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Destination</span>
                    <span class="detail-value" id="view-destination">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Employees</span>
                    <span class="detail-value" id="view-employees">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Travel Date</span>
                    <span class="detail-value" id="view-travel-date">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Travel End</span>
                    <span class="detail-value" id="view-travel-until">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">File</span>
                    <a class="link-btn" id="view-file-link" href="#" target="_blank" rel="noopener">Open file</a>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="close-view">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        // Initialize Supabase
        const supabaseUrl = "https://gptfbpktebajhvwvlfkd.supabase.co";
        const supabaseKey = "sb_publishable_TVtTKkPIWDXOf1ywQTgp5w_azlcjhLb";
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Logout functionality
        document.getElementById("logout-btn").addEventListener("click", async () => {
            try {
                await supabase.auth.signOut();
                window.location.href = "../index.html";
            } catch (error) {
                console.error("Logout error:", error);
                window.location.href = "../index.html";
            }
        });

        const getUserRole = async (userId) => {
            try {
                const { data, error } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", userId)
                    .maybeSingle();

                if (error) {
                    throw error;
                }

                return data?.role || "user";
            } catch (error) {
                console.error("Role lookup error:", error);
                return "user";
            }
        };

        const requireUser = async () => {
            const { data: sessionData, error } = await supabase.auth.getSession();
            if (error || !sessionData?.session) {
                window.location.href = "../index.html";
                return;
            }

            // Note: Access control is enforced by Supabase RLS policies.
            // Client-side checks are for UX only and should not be relied upon for security.
        };

        const taBody = document.getElementById("ta-body");
        const taStatus = document.getElementById("ta-status");
        const taMoreBtn = document.getElementById("ta-more");
        const pageSize = 20;
        let taOffset = 0;
        let taRows = [];
        let taHasMore = true;
        let activeFilters = {
            taNumber: "",
            employee: "",
            travelDate: "",
            matchAll: false
        };
        let employeesListForFilter = [];

        const formatFileLabel = (value) => {
            const base = String(value || "Download");
            const extMatch = base.match(/\.([a-z0-9]{1,5})$/i);
            const ext = extMatch ? `.${extMatch[1]}` : "";
            const nameWithoutExt = extMatch ? base.slice(0, -ext.length) : base;
            const compact = nameWithoutExt.replace(/[^a-z0-9-]/gi, "");
            if (compact.length <= 12) return compact + ext || "File";
            return `${compact.slice(0, 12)}...${ext}`;
        };
        const viewModal = document.getElementById("view-modal");
        const closeViewBtn = document.getElementById("close-view");
        const viewTaNumber = document.getElementById("view-ta-number");
        const viewPurpose = document.getElementById("view-purpose");
        const viewDestination = document.getElementById("view-destination");
        const viewEmployees = document.getElementById("view-employees");
        const viewTravelDate = document.getElementById("view-travel-date");
        const viewTravelUntil = document.getElementById("view-travel-until");
        const viewFileLink = document.getElementById("view-file-link");

        const applyClientFilters = (rows) => {
            // If no filters are active, return all rows
            if (!activeFilters.taNumber && !activeFilters.employee && !activeFilters.travelDate) {
                return rows;
            }

            return rows.filter(row => {
                const checks = [];

                // Check TA Number filter
                if (activeFilters.taNumber) {
                    const matchesTa = row.ta_number && row.ta_number.toLowerCase().includes(activeFilters.taNumber.toLowerCase());
                    checks.push(matchesTa);
                }

                // Check Employee filter (contains match for comma-separated values)
                if (activeFilters.employee) {
                    const matchesEmployee = row.employees && row.employees.toLowerCase().includes(activeFilters.employee.toLowerCase());
                    checks.push(matchesEmployee);
                }

                // Check Travel Date filter
                if (activeFilters.travelDate) {
                    const matchesDate = row.travel_date && row.travel_date === activeFilters.travelDate;
                    checks.push(matchesDate);
                }

                // Return based on match mode (AND or OR)
                if (activeFilters.matchAll) {
                    // AND: all filters must match
                    return checks.every(check => check === true);
                } else {
                    // OR: at least one filter must match
                    return checks.some(check => check === true);
                }
            });
        };

        const renderRows = (rows) => {
            const filteredRows = applyClientFilters(rows);
            
            if (!filteredRows.length) {
                taBody.innerHTML = "<tr><td colspan=\"8\">No records match the current filters.</td></tr>";
                return;
            }

            taBody.innerHTML = filteredRows.map((row, index) => {
                const dateText = row.travel_date ? new Date(row.travel_date).toLocaleDateString() : "-";
                const untilText = row.travel_until ? new Date(row.travel_until).toLocaleDateString() : "-";
                const fileUrl = row.file_url || "#";
                const safeName = row.file_name || "Download";
                const displayName = formatFileLabel(safeName);
                
                // Truncate employees to show max 2
                let employeesText = row.employees || "-";
                if (employeesText !== "-") {
                    const employeeArray = employeesText.split(",").map(e => e.trim());
                    if (employeeArray.length > 2) {
                        employeesText = employeeArray.slice(0, 2).join(", ") + "...";
                    }
                }

                return `
                    <tr>
                        <td>
                            <button class="view-btn icon-btn" data-index="${index}" aria-label="View details">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M12 5c5 0 9.3 3 11 7-1.7 4-6 7-11 7S2.7 16 1 12c1.7-4 6-7 11-7Zm0 2C8.3 7 5 9.1 3.4 12 5 14.9 8.3 17 12 17s7-2.1 8.6-5C19 9.1 15.7 7 12 7Zm0 2.2a2.8 2.8 0 1 1 0 5.6 2.8 2.8 0 0 1 0-5.6Z" />
                                </svg>
                            </button>
                        </td>
                        <td>${row.ta_number || "-"}</td>
                        <td><span class="truncate">${row.purpose || "-"}</span></td>
                        <td style="text-align: left;"><span class="truncate">${row.destination || "-"}</span></td>
                        <td style="text-align: left;"><span class="truncate">${employeesText}</span></td>
                        <td>${dateText}</td>
                        <td>${untilText}</td>
                        <td>
                            <a class="link-btn" href="${fileUrl}" target="_blank" rel="noopener">${displayName}</a>
                        </td>
                    </tr>
                `;
            }).join("");

            document.querySelectorAll(".view-btn").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    const index = Number(e.currentTarget.getAttribute("data-index"));
                    const record = filteredRows[index];
                    if (!record) return;

                    viewTaNumber.textContent = record.ta_number || "-";
                    viewPurpose.textContent = record.purpose || "-";
                    viewDestination.textContent = record.destination || "-";
                    viewEmployees.textContent = record.employees || "-";
                    viewTravelDate.textContent = record.travel_date
                        ? new Date(record.travel_date).toLocaleDateString()
                        : "-";
                    viewTravelUntil.textContent = record.travel_until
                        ? new Date(record.travel_until).toLocaleDateString()
                        : "-";

                    if (record.file_url) {
                        viewFileLink.href = record.file_url;
                        viewFileLink.textContent = record.file_name || "Open file";
                    } else {
                        viewFileLink.href = "#";
                        viewFileLink.textContent = "No file";
                    }

                    viewModal.classList.add("show");
                });
            });
        };

        const updateTaFooter = () => {
            const filteredCount = applyClientFilters(taRows).length;
            const hasActiveFilters = activeFilters.taNumber || activeFilters.employee || activeFilters.travelDate;
            
            if (!taRows.length) {
                taStatus.textContent = "No records yet.";
            } else if (hasActiveFilters) {
                taStatus.textContent = `Showing ${filteredCount} of ${taRows.length} record${taRows.length === 1 ? "" : "s"} (filtered).`;
            } else if (!taHasMore) {
                taStatus.textContent = "End of records.";
            } else {
                taStatus.textContent = `Loaded ${taRows.length} record${taRows.length === 1 ? "" : "s"}.`;
            }

            if (taMoreBtn) {
                taMoreBtn.hidden = !taHasMore;
            }
        };

        const loadTravelAuthorities = async (reset = false) => {
            if (reset) {
                taOffset = 0;
                taRows = [];
                taHasMore = true;
                taBody.innerHTML = "<tr><td colspan=\"7\">Loading records...</td></tr>";
            }

            if (!taHasMore) {
                updateTaFooter();
                return;
            }

            taStatus.textContent = "Fetching travel authorities.";
            try {
                const from = taOffset;
                const to = taOffset + pageSize - 1;
                const { data, error } = await supabase
                    .from("travel_authorities")
                    .select("ta_number, purpose, destination, employees, travel_date, travel_until, file_name, file_url, created_at")
                    .order("created_at", { ascending: false })
                    .range(from, to);

                if (error) {
                    throw error;
                }

                const nextRows = data || [];
                taRows = taRows.concat(nextRows);
                taOffset += nextRows.length;
                taHasMore = nextRows.length === pageSize;

                renderRows(taRows);
                updateTaFooter();
            } catch (error) {
                console.error("Dashboard load error:", error);
                taBody.innerHTML = "<tr><td colspan=\"7\">Unable to load records.</td></tr>";
                taStatus.textContent = "Failed to load travel authorities.";
            }
        };
        if (taMoreBtn) {
            taMoreBtn.addEventListener("click", () => {
                loadTravelAuthorities(false);
            });
        }

        closeViewBtn.addEventListener("click", () => {
            viewModal.classList.remove("show");
        });

        viewModal.addEventListener("click", (e) => {
            if (e.target === viewModal) {
                viewModal.classList.remove("show");
            }
        });

        // Filter panel functionality
        const filterToggleBtn = document.getElementById("filter-toggle-btn");
        const filterPanel = document.getElementById("filter-panel");
        const applyFilterBtn = document.getElementById("apply-filter-btn");
        const clearFilterBtn = document.getElementById("clear-filter-btn");
        const filterTaNumberInput = document.getElementById("filter-ta-number");
        const filterEmployeeSelect = document.getElementById("filter-employee");
        const filterTravelDateInput = document.getElementById("filter-travel-date");
        const filterMatchAllCheckbox = document.getElementById("filter-match-all");

        // Load employees for filter
        const loadEmployeesForFilter = async () => {
            try {
                const { data, error } = await supabase
                    .from("employee_list")
                    .select("name, is_active")
                    .order("is_active", { ascending: false })
                    .order("name", { ascending: true });

                if (error) throw error;
                employeesListForFilter = data ? data : [];
                
                // Populate filter dropdown
                filterEmployeeSelect.innerHTML = '<option value="">All Employees</option>' +
                    employeesListForFilter.map(emp => {
                        const inactiveLabel = emp.is_active === false ? ' (Inactive)' : '';
                        return `<option value="${emp.name}">${emp.name}${inactiveLabel}</option>`;
                    }).join('');
            } catch (error) {
                console.error("Failed to load employees for filter:", error);
                employeesListForFilter = [];
            }
        };

        // Auto-dash formatting for TA Number filter
        const formatTaNumber = (value) => {
            const digits = value.replace(/\D/g, "").slice(0, 10);
            const part1 = digits.slice(0, 4);
            const part2 = digits.slice(4, 6);
            const part3 = digits.slice(6, 10);
            if (digits.length <= 4) return part1;
            if (digits.length <= 6) return `${part1}-${part2}`;
            return `${part1}-${part2}-${part3}`;
        };

        filterTaNumberInput.addEventListener("input", () => {
            filterTaNumberInput.value = formatTaNumber(filterTaNumberInput.value);
        });

        // Initialize flatpickr for date filter
        window.flatpickr(filterTravelDateInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        filterToggleBtn.addEventListener("click", () => {
            filterPanel.classList.toggle("show");
        });

        applyFilterBtn.addEventListener("click", () => {
            activeFilters.taNumber = filterTaNumberInput.value.trim();
            activeFilters.employee = filterEmployeeSelect.value;
            activeFilters.travelDate = filterTravelDateInput.value;
            activeFilters.matchAll = filterMatchAllCheckbox.checked;
            renderRows(taRows);
            updateTaFooter();
            filterPanel.classList.remove("show");
        });

        clearFilterBtn.addEventListener("click", () => {
            activeFilters.taNumber = "";
            activeFilters.employee = "";
            activeFilters.travelDate = "";
            activeFilters.matchAll = false;
            filterTaNumberInput.value = "";
            filterEmployeeSelect.value = "";
            filterTravelDateInput.value = "";
            filterMatchAllCheckbox.checked = false;
            renderRows(taRows);
            updateTaFooter();
        });

        // Close filter panel when clicking outside
        document.addEventListener("click", (e) => {
            if (!filterPanel.contains(e.target) && !filterToggleBtn.contains(e.target) && filterPanel.classList.contains("show")) {
                filterPanel.classList.remove("show");
            }
        });

        const init = async () => {
            await requireUser();
            await loadEmployeesForFilter();
            await loadTravelAuthorities(true);
        };

        init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

    <div id="footer-container"></div>
    <script>
        fetch('../footer/footer.html')
            .then(response => response.text())
            .then(data => {
                const footerHTML = data.replace(/FOOTER_ASSETS_PATH/g, '../assets');
                document.getElementById('footer-container').innerHTML = footerHTML;
            })
            .catch(error => console.error('Error loading footer:', error));
    </script>

</body>
</html>
