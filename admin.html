<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <h1>Admin Panel</h1>
        <button id="logout-btn" type="button" class="logout-btn">Log Out</button>
    </header>
    <div class="panel-switcher">
        <button class="switch-btn active" data-panel="upload-panel">Upload Files</button>
        <button class="switch-btn" data-panel="view-panel">View & Manage</button>
    </div>
    <section class="panel" id="upload-panel">
        <h2>Travel Authority Upload</h2>
        <div class="fields">
            <div>
                <label for="ta-number">TA Number</label>
                <div class="input-wrap">
                    <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                            <path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V8h4.5L14 3.5ZM8 12h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                        </svg>
                    </span>
                    <input id="ta-number" type="text" placeholder="Enter TA Number" required>
                </div>
            </div>
            <div>
                <label for="travel-date">Travel Date</label>
                <div class="input-wrap">
                    <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                            <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                        </svg>
                    </span>
                    <input id="travel-date" type="text" placeholder="Select travel date" required>
                </div>
            </div>
            <div>
                <label for="scan-file">Upload Scanned</label>
                <input id="scan-file" type="file" required>
            </div>
        </div>
        <div class="row">
            <button id="upload-btn" type="button">Upload</button>
            <span class="status" id="upload-status">Complete the required fields.</span>
        </div>
    </section>

    <section class="panel hidden" id="view-panel">
        <div class="panel-head">
            <h2>Travel Authorities</h2>
            <span class="pill">Admin Access</span>
        </div>
        <div class="table-wrap">
            <table class="data-table" aria-describedby="view-status">
                <thead>
                    <tr>
                        <th scope="col">TA Number</th>
                        <th scope="col">Travel Date</th>
                        <th scope="col">File</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="view-body">
                    <tr>
                        <td colspan="4">Loading records...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <span class="status" id="view-status">Fetching travel authorities.</span>
    </section>

    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete this travel authority record? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancel-delete">Cancel</button>
                <button class="modal-btn confirm" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script type="module">
        // Import Supabase
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        // Initialize Supabase
        const supabaseUrl = "https://gptfbpktebajhvwvlfkd.supabase.co";
        const supabaseKey = "sb_publishable_TVtTKkPIWDXOf1ywQTgp5w_azlcjhLb";
        const supabase = createClient(supabaseUrl, supabaseKey);

        const getUserRole = async (userId) => {
            try {
                const { data, error } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", userId)
                    .maybeSingle();

                if (error) {
                    throw error;
                }

                return data?.role || "user";
            } catch (error) {
                console.error("Role lookup error:", error);
                return "user";
            }
        };

        const requireAdmin = async () => {
            const { data: sessionData, error } = await supabase.auth.getSession();
            if (error || !sessionData?.session) {
                window.location.href = "index.html";
                return;
            }

            // Note: Actual access control for admin operations (upload, delete) 
            // is enforced by Supabase RLS policies, not this client-side check.
            // This check is for UX only and should not be fully trusted for security.
        };

        // Logout functionality
        document.getElementById("logout-btn").addEventListener("click", async () => {
            try {
                await supabase.auth.signOut();
                window.location.href = "index.html";
            } catch (error) {
                console.error("Logout error:", error);
                window.location.href = "index.html";
            }
        });

        const uploadStatus = document.getElementById("upload-status");
        const taNumberInput = document.getElementById("ta-number");
        const travelDateInput = document.getElementById("travel-date");
        const scanFileInput = document.getElementById("scan-file");

        window.flatpickr(travelDateInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        scanFileInput.addEventListener("change", () => {
            if (scanFileInput.files.length > 0) {
                uploadStatus.textContent = `Selected: ${scanFileInput.files[0].name}`;
            } else {
                uploadStatus.textContent = "Complete the required fields.";
            }
        });

        document.getElementById("upload-btn").addEventListener("click", async () => {
            const taNumber = taNumberInput.value.trim();
            const travelDate = travelDateInput.value;

            const file = scanFileInput.files[0];

            if (!taNumber || !travelDate || !file) {
                uploadStatus.textContent = "Please fill in all required fields.";
                uploadStatus.classList.add("status--error");
                uploadStatus.classList.remove("status--shake");
                void uploadStatus.offsetWidth;
                uploadStatus.classList.add("status--shake");
                return;
            }

            try {
                const safeTa = taNumber.replace(/[^a-z0-9-_]/gi, "_");
                const safeDate = travelDate.replace(/[^0-9-]/g, "-");
                const filePath = `travel-authorities/${safeTa}/${safeDate}/${file.name}`;

                uploadStatus.textContent = "Uploading...";
                uploadStatus.classList.remove("status--error");

                const { error: uploadError } = await supabase
                    .storage
                    .from("ta-files")
                    .upload(filePath, file, { upsert: true });

                if (uploadError) {
                    throw uploadError;
                }

                const { data: publicUrlData } = supabase
                    .storage
                    .from("ta-files")
                    .getPublicUrl(filePath);

                const fileUrl = publicUrlData.publicUrl;

                const { error: insertError } = await supabase
                    .from("travel_authorities")
                    .insert([
                        {
                            ta_number: taNumber,
                            travel_date: travelDate,
                            file_name: file.name,
                            file_url: fileUrl
                        }
                    ]);

                if (insertError) {
                    throw insertError;
                }

                uploadStatus.textContent = "Upload complete.";
                console.log("File URL:", fileUrl);
            } catch (error) {
                console.error("Upload error:", error);
                const message = error && error.message ? error.message : "Please try again.";
                uploadStatus.textContent = `Upload failed: ${message}`;
                uploadStatus.classList.add("status--error");
                uploadStatus.classList.remove("status--shake");
                void uploadStatus.offsetWidth;
                uploadStatus.classList.add("status--shake");
            }
        });

        // Panel switching logic
        const switchButtons = document.querySelectorAll(".switch-btn");
        const uploadPanel = document.getElementById("upload-panel");
        const viewPanel = document.getElementById("view-panel");

        switchButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const targetPanel = btn.getAttribute("data-panel");
                
                // Update active button
                switchButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");

                // Show/hide panels
                if (targetPanel === "upload-panel") {
                    uploadPanel.classList.remove("hidden");
                    viewPanel.classList.add("hidden");
                } else {
                    uploadPanel.classList.add("hidden");
                    viewPanel.classList.remove("hidden");
                    loadTravelAuthorities();
                }
            });
        });

        // Table view functionality
        const viewBody = document.getElementById("view-body");
        const viewStatus = document.getElementById("view-status");
        const deleteModal = document.getElementById("delete-modal");
        const cancelDeleteBtn = document.getElementById("cancel-delete");
        const confirmDeleteBtn = document.getElementById("confirm-delete");
        let deleteRecordData = null;

        const renderViewRows = (rows) => {
            if (!rows.length) {
                viewBody.innerHTML = "<tr><td colspan=\"4\">No records yet.</td></tr>";
                return;
            }

            viewBody.innerHTML = rows.map((row) => {
                const dateText = row.travel_date ? new Date(row.travel_date).toLocaleDateString() : "-";
                const fileUrl = row.file_url || "#";
                const safeName = row.file_name || "Download";

                return `
                    <tr data-id="${row.id}" data-file-url="${fileUrl}">
                        <td>${row.ta_number || "-"}</td>
                        <td>${dateText}</td>
                        <td>
                            <a class="link-btn" href="${fileUrl}" target="_blank" rel="noopener">${safeName}</a>
                        </td>
                        <td>
                            <button class="delete-btn" data-id="${row.id}">Delete</button>
                        </td>
                    </tr>
                `;
            }).join("");

            // Add delete button event listeners
            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const row = e.target.closest("tr");
                    const recordId = row?.getAttribute("data-id") || "";
                    const recordFileUrl = row?.getAttribute("data-file-url") || "";
                    deleteRecordData = {
                        id: recordId.trim(),
                        file_url: recordFileUrl
                    };
                    deleteModal.classList.add("show");
                });
            });
        };

        const loadTravelAuthorities = async () => {
            viewStatus.textContent = "Fetching travel authorities.";
            try {
                const { data, error } = await supabase
                    .from("travel_authorities")
                    .select("id, ta_number, travel_date, file_name, file_url, created_at")
                    .order("created_at", { ascending: false });

                if (error) {
                    throw error;
                }

                renderViewRows(data || []);
                viewStatus.textContent = `Loaded ${data.length} record${data.length === 1 ? "" : "s"}.`;
            } catch (error) {
                console.error("View load error:", error);
                viewBody.innerHTML = "<tr><td colspan=\"4\">Unable to load records.</td></tr>";
                viewStatus.textContent = "Failed to load travel authorities.";
            }
        };

        // Delete modal handlers
        cancelDeleteBtn.addEventListener("click", () => {
            deleteModal.classList.remove("show");
            deleteRecordData = null;
        });

        confirmDeleteBtn.addEventListener("click", async () => {
            if (!deleteRecordData || !deleteRecordData.id) return;

            try {
                viewStatus.textContent = "Deleting record...";
                
                // Delete database record first
                const { error: deleteError } = await supabase
                    .from("travel_authorities")
                    .delete()
                    .eq("id", deleteRecordData.id);

                if (deleteError) {
                    throw deleteError;
                }

                // Extract file path from URL and delete from storage
                if (deleteRecordData.file_url) {
                    try {
                        const url = new URL(deleteRecordData.file_url);
                        const pathParts = url.pathname.split('/ta-files/');
                        if (pathParts.length > 1) {
                            const filePath = decodeURIComponent(pathParts[1]);
                            
                            const { error: storageError } = await supabase
                                .storage
                                .from("ta-files")
                                .remove([filePath]);

                            if (storageError) {
                                console.warn("Storage delete warning:", storageError);
                            }
                        }
                    } catch (urlError) {
                        console.warn("File path extraction error:", urlError);
                    }
                }

                deleteModal.classList.remove("show");
                viewStatus.textContent = "Record deleted successfully.";
                deleteRecordData = null;
                
                // Reload the table
                await loadTravelAuthorities();
            } catch (error) {
                console.error("Delete error:", error);
                viewStatus.textContent = `Delete failed: ${error.message || "Unknown error"}`;
                deleteModal.classList.remove("show");
                deleteRecordData = null;
            }
        });

        // Close modal when clicking outside
        deleteModal.addEventListener("click", (e) => {
            if (e.target === deleteModal) {
                deleteModal.classList.remove("show");
                deleteRecordData = null;
            }
        });

        requireAdmin();
    </script>
</body>
</html>
