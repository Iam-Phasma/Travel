<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <h1>Admin Panel</h1>
        <button id="logout-btn" type="button" class="logout-btn">Log Out</button>
    </header>
    <div class="panel-switcher">
        <button class="switch-btn active" data-panel="upload-panel">Upload Files</button>
        <button class="switch-btn" data-panel="view-panel">View & Manage</button>
    </div>
    <section class="panel" id="upload-panel">
        <h2>Travel Authority Upload</h2>
        <div class="fields">
            <div>
                <label for="ta-number">TA Number <span class="required">*</span></label>
                <div class="input-wrap">
                    <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                            <path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V8h4.5L14 3.5ZM8 12h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                        </svg>
                    </span>
                    <input id="ta-number" type="text" placeholder="0000-00-0000" pattern="\d{4}-\d{2}-\d{4}" maxlength="12" inputmode="numeric" required>
                </div>
            </div>
            <div>
                <label for="purpose">Purpose <span class="required">*</span></label>
                <div class="input-wrap">
                    <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                            <path d="M4 5h16a1 1 0 0 1 1 1v10a3 3 0 0 1-3 3H8a5 5 0 0 1-5-5V6a1 1 0 0 1 1-1Zm1 2v7a3 3 0 0 0 3 3h10a1 1 0 0 0 1-1V7H5Zm3 1h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                        </svg>
                    </span>
                    <input id="purpose" type="text" placeholder="Enter travel purpose" required>
                </div>
            </div>
            <div class="field-row">
                <div>
                    <label for="travel-date">Travel Date <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                            </svg>
                        </span>
                        <input id="travel-date" type="text" placeholder="Select travel date" required>
                    </div>
                </div>
                <div>
                    <label for="travel-until">Travel Until</label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                            </svg>
                        </span>
                        <input id="travel-until" type="text" placeholder="Select end date">
                    </div>
                </div>
            </div>
            <div>
                <label for="scan-file">Upload Scanned <span class="required">*</span></label>
                <input id="scan-file" type="file" required>
            </div>
        </div>
        <div class="row">
            <button id="upload-btn" type="button">Upload</button>
            <span class="status" id="upload-status">Complete the required fields.</span>
        </div>
    </section>

    <section class="panel wide-panel hidden" id="view-panel">
        <div class="panel-head">
            <h2>Travel Authorities</h2>
            <span class="pill">Admin Access</span>
        </div>
        <div class="table-wrap max-rows-10">
            <table class="data-table" aria-describedby="view-status">
                <thead>
                    <tr>
                        <th scope="col">TA Number</th>
                        <th scope="col">Purpose</th>
                        <th scope="col">Travel Date</th>
                        <th scope="col">Travel Until</th>
                        <th scope="col">File</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="view-body">
                    <tr>
                        <td colspan="6">Loading records...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <span class="status" id="view-status">Fetching travel authorities.</span>
    </section>

    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete this travel authority record? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancel-delete">Cancel</button>
                <button class="modal-btn confirm" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <div id="update-modal" class="modal">
        <div class="modal-content modal-form">
            <h3>Update Travel Authority</h3>
            <p>Updating will overwrite the existing record.</p>
            <div class="fields">
                <div>
                    <label for="update-ta-number">TA Number <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V8h4.5L14 3.5ZM8 12h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                            </svg>
                        </span>
                        <input id="update-ta-number" type="text" placeholder="0000-00-0000" pattern="\d{4}-\d{2}-\d{4}" maxlength="12" inputmode="numeric" required>
                    </div>
                </div>
                <div>
                    <label for="update-purpose">Purpose <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M4 5h16a1 1 0 0 1 1 1v10a3 3 0 0 1-3 3H8a5 5 0 0 1-5-5V6a1 1 0 0 1 1-1Zm1 2v7a3 3 0 0 0 3 3h10a1 1 0 0 0 1-1V7H5Zm3 1h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                            </svg>
                        </span>
                        <input id="update-purpose" type="text" placeholder="Enter travel purpose" required>
                    </div>
                </div>
                <div class="field-row">
                    <div>
                        <label for="update-travel-date">Travel Date <span class="required">*</span></label>
                        <div class="input-wrap">
                            <span class="icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                                </svg>
                            </span>
                            <input id="update-travel-date" type="text" placeholder="Select travel date" required>
                        </div>
                    </div>
                    <div>
                        <label for="update-travel-until">Travel Until</label>
                        <div class="input-wrap">
                            <span class="icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                                </svg>
                            </span>
                            <input id="update-travel-until" type="text" placeholder="Select end date">
                        </div>
                    </div>
                </div>
                <div>
                    <label for="update-scan-file">Upload Scanned</label>
                    <input id="update-scan-file" type="file">
                    <p class="disclaimer">Leave empty to keep the current file.</p>
                </div>
            </div>
            <span class="status" id="update-status">Update the fields and choose a new file if needed.</span>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancel-update">Cancel</button>
                <button class="modal-btn confirm" id="confirm-update">Update</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script type="module">
        // Import Supabase
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        // Initialize Supabase
        const supabaseUrl = "https://gptfbpktebajhvwvlfkd.supabase.co";
        const supabaseKey = "sb_publishable_TVtTKkPIWDXOf1ywQTgp5w_azlcjhLb";
        const supabase = createClient(supabaseUrl, supabaseKey);

        const getUserRole = async (userId) => {
            try {
                const { data, error } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", userId)
                    .maybeSingle();

                if (error) {
                    throw error;
                }

                return data?.role || "user";
            } catch (error) {
                console.error("Role lookup error:", error);
                return "user";
            }
        };

        const requireAdmin = async () => {
            const { data: sessionData, error } = await supabase.auth.getSession();
            if (error || !sessionData?.session) {
                window.location.href = "index.html";
                return;
            }

            // Note: Actual access control for admin operations (upload, delete) 
            // is enforced by Supabase RLS policies, not this client-side check.
            // This check is for UX only and should not be fully trusted for security.
        };

        // Logout functionality
        document.getElementById("logout-btn").addEventListener("click", async () => {
            try {
                await supabase.auth.signOut();
                window.location.href = "index.html";
            } catch (error) {
                console.error("Logout error:", error);
                window.location.href = "index.html";
            }
        });

        const uploadStatus = document.getElementById("upload-status");
        const taNumberInput = document.getElementById("ta-number");
        const purposeInput = document.getElementById("purpose");
        const travelDateInput = document.getElementById("travel-date");
        const travelUntilInput = document.getElementById("travel-until");
        const scanFileInput = document.getElementById("scan-file");

        window.flatpickr(travelDateInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        window.flatpickr(travelUntilInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        const isValidTaNumber = (value) => /^\d{4}-\d{2}-\d{4}$/.test(value);
        const formatTaNumber = (value) => {
            const digits = value.replace(/\D/g, "").slice(0, 10);
            const part1 = digits.slice(0, 4);
            const part2 = digits.slice(4, 6);
            const part3 = digits.slice(6, 10);
            if (digits.length <= 4) return part1;
            if (digits.length <= 6) return `${part1}-${part2}`;
            return `${part1}-${part2}-${part3}`;
        };

        const bindTaFormatter = (input) => {
            input.addEventListener("input", () => {
                input.value = formatTaNumber(input.value);
            });
        };

        bindTaFormatter(taNumberInput);
        bindTaFormatter(updateTaInput);

        scanFileInput.addEventListener("change", () => {
            if (scanFileInput.files.length > 0) {
                uploadStatus.textContent = `Selected: ${scanFileInput.files[0].name}`;
            } else {
                uploadStatus.textContent = "Complete the required fields.";
            }
        });

        document.getElementById("upload-btn").addEventListener("click", async () => {
            const taNumber = taNumberInput.value.trim();
            const purpose = purposeInput.value.trim();
            const travelDate = travelDateInput.value;
            let travelUntil = travelUntilInput.value;

            const file = scanFileInput.files[0];

            if (!taNumber || !purpose || !travelDate || !file) {
                uploadStatus.textContent = "Please fill in all required fields.";
                uploadStatus.classList.add("status--error");
                uploadStatus.classList.remove("status--shake");
                void uploadStatus.offsetWidth;
                uploadStatus.classList.add("status--shake");
                return;
            }

            if (!isValidTaNumber(taNumber)) {
                uploadStatus.textContent = "TA Number must be in the format 0000-00-0000.";
                uploadStatus.classList.add("status--error");
                uploadStatus.classList.remove("status--shake");
                void uploadStatus.offsetWidth;
                uploadStatus.classList.add("status--shake");
                return;
            }

            if (!travelUntil) {
                travelUntil = travelDate;
                travelUntilInput.value = travelDate;
            }

            if (travelUntil) {
                const start = new Date(`${travelDate}T00:00:00`);
                const end = new Date(`${travelUntil}T00:00:00`);
                if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
                    uploadStatus.textContent = "Please enter valid dates.";
                    uploadStatus.classList.add("status--error");
                    uploadStatus.classList.remove("status--shake");
                    void uploadStatus.offsetWidth;
                    uploadStatus.classList.add("status--shake");
                    return;
                }

                if (start > end) {
                    uploadStatus.textContent = "Travel date cannot be after travel until.";
                    uploadStatus.classList.add("status--error");
                    uploadStatus.classList.remove("status--shake");
                    void uploadStatus.offsetWidth;
                    uploadStatus.classList.add("status--shake");
                    return;
                }
            }

            try {
                uploadStatus.textContent = "Uploading...";
                uploadStatus.classList.remove("status--error");

                // Verify user is authenticated
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                if (sessionError || !sessionData?.session) {
                    throw new Error("No active session. Please log in again.");
                }

                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    throw new Error("Not authenticated");
                }

                const { data: profile, error: profileError } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", user.id)
                    .maybeSingle();

                if (profileError || profile?.role !== "admin") {
                    throw new Error("Not authorized to upload.");
                }

                const safeTa = taNumber.replace(/[^a-z0-9-_]/gi, "_");
                const safeDate = travelDate.replace(/[^0-9-]/g, "-");
                const uniqueName = `${Date.now()}_${file.name}`;
                const filePath = `travel-authorities/${safeTa}/${safeDate}/${uniqueName}`;

                const { error: uploadError } = await supabase
                    .storage
                    .from("ta-files")
                    .upload(filePath, file, { upsert: false });

                if (uploadError) {
                    throw new Error(`Storage upload failed: ${uploadError.message || "Unknown error"}`);
                }

                const { data: publicUrlData } = supabase
                    .storage
                    .from("ta-files")
                    .getPublicUrl(filePath);

                const fileUrl = publicUrlData.publicUrl;

                const { error: insertError } = await supabase
                    .from("travel_authorities")
                    .insert([
                        {
                            ta_number: taNumber,
                            purpose: purpose,
                            travel_date: travelDate,
                            travel_until: travelUntil,
                            file_name: file.name,
                            file_url: fileUrl
                        }
                    ]);

                if (insertError) {
                    throw new Error(`Database insert failed: ${insertError.message || "Unknown error"}`);
                }

                uploadStatus.textContent = "Upload complete.";
                console.log("File URL:", fileUrl);
            } catch (error) {
                console.error("Upload error:", error);
                const message = error && error.message ? error.message : "Please try again.";
                uploadStatus.textContent = `Upload failed: ${message}`;
                uploadStatus.classList.add("status--error");
                uploadStatus.classList.remove("status--shake");
                void uploadStatus.offsetWidth;
                uploadStatus.classList.add("status--shake");
            }
        });

        // Panel switching logic
        const switchButtons = document.querySelectorAll(".switch-btn");
        const uploadPanel = document.getElementById("upload-panel");
        const viewPanel = document.getElementById("view-panel");

        switchButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const targetPanel = btn.getAttribute("data-panel");
                
                // Update active button
                switchButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");

                // Show/hide panels
                if (targetPanel === "upload-panel") {
                    uploadPanel.classList.remove("hidden");
                    viewPanel.classList.add("hidden");
                } else {
                    uploadPanel.classList.add("hidden");
                    viewPanel.classList.remove("hidden");
                    loadTravelAuthorities();
                }
            });
        });

        // Table view functionality
        const viewBody = document.getElementById("view-body");
        const viewStatus = document.getElementById("view-status");
        const deleteModal = document.getElementById("delete-modal");
        const updateModal = document.getElementById("update-modal");
        const cancelDeleteBtn = document.getElementById("cancel-delete");
        const confirmDeleteBtn = document.getElementById("confirm-delete");
        const cancelUpdateBtn = document.getElementById("cancel-update");
        const confirmUpdateBtn = document.getElementById("confirm-update");
        const updateTaInput = document.getElementById("update-ta-number");
        const updatePurposeInput = document.getElementById("update-purpose");
        const updateTravelDateInput = document.getElementById("update-travel-date");
        const updateTravelUntilInput = document.getElementById("update-travel-until");
        const updateScanFileInput = document.getElementById("update-scan-file");
        const updateStatus = document.getElementById("update-status");
        const toast = document.getElementById("toast");
        const recordCache = new Map();
        let deleteRecordData = null;
        let updateRecordData = null;
        let toastTimer = null;

        const showToast = (message) => {
            if (!toast) return;
            toast.textContent = message;
            toast.classList.add("show");
            if (toastTimer) {
                clearTimeout(toastTimer);
            }
            toastTimer = setTimeout(() => {
                toast.classList.remove("show");
            }, 2600);
        };

        window.flatpickr(updateTravelDateInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        window.flatpickr(updateTravelUntilInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        const renderViewRows = (rows) => {
            if (!rows.length) {
                recordCache.clear();
                viewBody.innerHTML = "<tr><td colspan=\"6\">No records yet.</td></tr>";
                return;
            }

            recordCache.clear();
            rows.forEach((row) => {
                recordCache.set(String(row.id), row);
            });

            viewBody.innerHTML = rows.map((row) => {
                const dateText = row.travel_date ? new Date(row.travel_date).toLocaleDateString() : "-";
                const untilText = row.travel_until ? new Date(row.travel_until).toLocaleDateString() : "-";
                const fileUrl = row.file_url || "#";
                const safeName = row.file_name || "Download";

                return `
                    <tr data-id="${row.id}">
                        <td>${row.ta_number || "-"}</td>
                        <td>${row.purpose || "-"}</td>
                        <td>${dateText}</td>
                        <td>${untilText}</td>
                        <td>
                            <a class="link-btn" href="${fileUrl}" target="_blank" rel="noopener">${safeName}</a>
                        </td>
                        <td>
                            <button class="update-btn" data-id="${row.id}">Update</button>
                            <button class="delete-btn icon-btn" data-id="${row.id}" aria-label="Delete">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M9 3h6l1 2h4a1 1 0 1 1 0 2h-1l-1.1 12.1a2 2 0 0 1-2 1.9H8.1a2 2 0 0 1-2-1.9L5 7H4a1 1 0 0 1 0-2h4l1-2Zm1.1 7a1 1 0 1 0-2 0v7a1 1 0 1 0 2 0v-7Zm5.9 0a1 1 0 1 0-2 0v7a1 1 0 1 0 2 0v-7Z" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join("");

            // Add delete button event listeners
            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const row = e.target.closest("tr");
                    const recordId = (row?.getAttribute("data-id") || "").trim();
                    const record = recordCache.get(recordId);
                    deleteRecordData = {
                        id: recordId,
                        file_url: record?.file_url || ""
                    };
                    deleteModal.classList.add("show");
                });
            });

            document.querySelectorAll(".update-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const row = e.target.closest("tr");
                    if (!row) return;
                    const recordId = (row.getAttribute("data-id") || "").trim();
                    const record = recordCache.get(recordId);
                    if (!recordId || !record) return;

                    updateRecordData = {
                        id: recordId,
                        file_url: record.file_url || "",
                        file_name: record.file_name || ""
                    };

                    updateTaInput.value = record.ta_number || "";
                    updatePurposeInput.value = record.purpose || "";
                    updateTravelDateInput.value = record.travel_date || "";
                    updateTravelUntilInput.value = record.travel_until || "";
                    updateScanFileInput.value = "";
                    updateStatus.textContent = "Update the fields and choose a new file if needed.";
                    updateStatus.classList.remove("status--error");

                    updateModal.classList.add("show");
                });
            });
        };

        const loadTravelAuthorities = async () => {
            viewStatus.textContent = "Fetching travel authorities.";
            try {
                const { data, error } = await supabase
                    .from("travel_authorities")
                    .select("id, ta_number, purpose, travel_date, travel_until, file_name, file_url, created_at")
                    .order("created_at", { ascending: false });

                if (error) {
                    throw error;
                }

                renderViewRows(data || []);
                viewStatus.textContent = `Loaded ${data.length} record${data.length === 1 ? "" : "s"}.`;
            } catch (error) {
                console.error("View load error:", error);
                viewBody.innerHTML = "<tr><td colspan=\"6\">Unable to load records.</td></tr>";
                viewStatus.textContent = "Failed to load travel authorities.";
            }
        };

        // Delete modal handlers
        cancelDeleteBtn.addEventListener("click", () => {
            deleteModal.classList.remove("show");
            deleteRecordData = null;
        });

        cancelUpdateBtn.addEventListener("click", () => {
            updateModal.classList.remove("show");
            updateRecordData = null;
        });

        confirmDeleteBtn.addEventListener("click", async () => {
            if (!deleteRecordData || !deleteRecordData.id) return;

            try {
                viewStatus.textContent = "Deleting record...";
                
                // Delete database record first
                const { error: deleteError } = await supabase
                    .from("travel_authorities")
                    .delete()
                    .eq("id", deleteRecordData.id);

                if (deleteError) {
                    throw deleteError;
                }

                // Extract file path from URL and delete from storage
                if (deleteRecordData.file_url) {
                    try {
                        const url = new URL(deleteRecordData.file_url);
                        const pathParts = url.pathname.split('/ta-files/');
                        if (pathParts.length > 1) {
                            const filePath = decodeURIComponent(pathParts[1]);
                            
                            const { error: storageError } = await supabase
                                .storage
                                .from("ta-files")
                                .remove([filePath]);

                            if (storageError) {
                                console.warn("Storage delete warning:", storageError);
                            }
                        }
                    } catch (urlError) {
                        console.warn("File path extraction error:", urlError);
                    }
                }

                deleteModal.classList.remove("show");
                viewStatus.textContent = "Record deleted successfully.";
                deleteRecordData = null;
                
                // Reload the table
                await loadTravelAuthorities();
            } catch (error) {
                console.error("Delete error:", error);
                viewStatus.textContent = `Delete failed: ${error.message || "Unknown error"}`;
                deleteModal.classList.remove("show");
                deleteRecordData = null;
            }
        });

        confirmUpdateBtn.addEventListener("click", async () => {
            if (!updateRecordData || !updateRecordData.id) return;

            const taNumber = updateTaInput.value.trim();
            const purpose = updatePurposeInput.value.trim();
            const travelDate = updateTravelDateInput.value;
            let travelUntil = updateTravelUntilInput.value;
            const file = updateScanFileInput.files[0];

            if (!taNumber || !purpose || !travelDate) {
                updateStatus.textContent = "Please fill in all required fields.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            if (!isValidTaNumber(taNumber)) {
                updateStatus.textContent = "TA Number must be in the format 0000-00-0000.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            if (!travelUntil) {
                travelUntil = travelDate;
                updateTravelUntilInput.value = travelDate;
            }

            const start = new Date(`${travelDate}T00:00:00`);
            const end = new Date(`${travelUntil}T00:00:00`);
            if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
                updateStatus.textContent = "Please enter valid dates.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            if (start > end) {
                updateStatus.textContent = "Travel date cannot be after travel until.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            try {
                updateStatus.textContent = "Updating...";
                updateStatus.classList.remove("status--error");

                let fileUrl = updateRecordData.file_url || "";
                let fileName = updateRecordData.file_name || "";

                if (file) {
                    const safeTa = taNumber.replace(/[^a-z0-9-_]/gi, "_");
                    const safeDate = travelDate.replace(/[^0-9-]/g, "-");
                    const uniqueName = `${Date.now()}_${file.name}`;
                    const filePath = `travel-authorities/${safeTa}/${safeDate}/${uniqueName}`;

                    const { error: uploadError } = await supabase
                        .storage
                        .from("ta-files")
                        .upload(filePath, file, { upsert: false });

                    if (uploadError) {
                        throw new Error(`Storage upload failed: ${uploadError.message || "Unknown error"}`);
                    }

                    const { data: publicUrlData } = supabase
                        .storage
                        .from("ta-files")
                        .getPublicUrl(filePath);

                    fileUrl = publicUrlData.publicUrl;
                    fileName = file.name;
                }

                const { error: updateError } = await supabase
                    .from("travel_authorities")
                    .update({
                        ta_number: taNumber,
                        purpose: purpose,
                        travel_date: travelDate,
                        travel_until: travelUntil,
                        file_name: fileName,
                        file_url: fileUrl
                    })
                    .eq("id", updateRecordData.id);

                if (updateError) {
                    throw new Error(`Database update failed: ${updateError.message || "Unknown error"}`);
                }

                if (file && updateRecordData.file_url) {
                    try {
                        const url = new URL(updateRecordData.file_url);
                        const pathParts = url.pathname.split('/ta-files/');
                        if (pathParts.length > 1) {
                            const oldFilePath = decodeURIComponent(pathParts[1]);

                            const { error: storageError } = await supabase
                                .storage
                                .from("ta-files")
                                .remove([oldFilePath]);

                            if (storageError) {
                                console.warn("Storage delete warning:", storageError);
                            }
                        }
                    } catch (urlError) {
                        console.warn("File path extraction error:", urlError);
                    }
                }

                updateModal.classList.remove("show");
                updateRecordData = null;
                viewStatus.textContent = "Record updated successfully.";
                showToast("Update saved.");
                await loadTravelAuthorities();
            } catch (error) {
                console.error("Update error:", error);
                const message = error && error.message ? error.message : "Please try again.";
                updateStatus.textContent = `Update failed: ${message}`;
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
            }
        });

        // Close modal when clicking outside
        deleteModal.addEventListener("click", (e) => {
            if (e.target === deleteModal) {
                deleteModal.classList.remove("show");
                deleteRecordData = null;
            }
        });

        updateModal.addEventListener("click", (e) => {
            if (e.target === updateModal) {
                updateModal.classList.remove("show");
                updateRecordData = null;
            }
        });

        requireAdmin();
    </script>
</body>
</html>
