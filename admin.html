<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <h1>Admin Panel</h1>
        <button id="logout-btn" type="button" class="logout-btn">Log Out</button>
    </header>
    <div class="panel-switcher">
        <button class="switch-btn active" data-panel="upload-panel">Upload Files</button>
        <button class="switch-btn" data-panel="view-panel">View & Manage</button>
    </div>
    <section class="panel" id="upload-panel">
        <h2>Travel Authority Upload</h2>
        <div class="fields">
            <div>
                <label for="ta-number">TA Number <span class="required">*</span></label>
                <div class="input-wrap">
                    <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                            <path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V8h4.5L14 3.5ZM8 12h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                        </svg>
                    </span>
                    <input id="ta-number" type="text" placeholder="0000-00-0000" pattern="\d{4}-\d{2}-\d{4}" maxlength="12" inputmode="numeric" required>
                </div>
            </div>
            <div>
                <label for="purpose">Purpose <span class="required">*</span></label>
                <div class="input-wrap">
                    <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                            <path d="M4 5h16a1 1 0 0 1 1 1v10a3 3 0 0 1-3 3H8a5 5 0 0 1-5-5V6a1 1 0 0 1 1-1Zm1 2v7a3 3 0 0 0 3 3h10a1 1 0 0 0 1-1V7H5Zm3 1h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                        </svg>
                    </span>
                    <input id="purpose" type="text" placeholder="Enter travel purpose" required>
                </div>
            </div>
            <div>
                <label for="destination">Destination <span class="required">*</span></label>
                <div class="input-wrap">
                    <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                            <path d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z" />
                        </svg>
                    </span>
                    <input id="destination" type="text" placeholder="Enter destination" required>
                </div>
            </div>
            <div class="field-row">
                <div>
                    <label for="travel-date">Travel Date <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                            </svg>
                        </span>
                        <input id="travel-date" type="text" placeholder="Select travel date" required>
                    </div>
                </div>
                <div>
                    <label for="travel-until">Travel Until</label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                            </svg>
                        </span>
                        <input id="travel-until" type="text" placeholder="Select end date">
                    </div>
                </div>
            </div>
            <div>
                <label for="scan-file">Upload Scanned <span class="required">*</span></label>
                <input id="scan-file" type="file" required>
            </div>
        </div>
        <div class="row">
            <button id="upload-btn" type="button">Upload</button>
            <span class="status" id="upload-status">Complete the required fields.</span>
        </div>
    </section>

    <section class="panel wide-panel hidden" id="view-panel">
        <div class="panel-head">
            <h2>Travel Authorities</h2>
            <span class="pill">Admin Access</span>
        </div>
        <div class="table-wrap max-rows-10">
            <table class="data-table" aria-describedby="view-status">
                <thead>
                    <tr>
                        <th scope="col">View</th>
                        <th scope="col">TA Number</th>
                        <th scope="col">Purpose</th>
                        <th scope="col">Destination</th>
                        <th scope="col">Travel Date</th>
                        <th scope="col">Travel Until</th>
                        <th scope="col">File</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="view-body">
                    <tr>
                        <td colspan="8">Loading records...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="table-footer">
            <span class="status" id="view-status">Fetching travel authorities.</span>
            <button id="view-more" class="pagination-btn" type="button">Load more</button>
        </div>
    </section>

    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete this travel authority record? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancel-delete">Cancel</button>
                <button class="modal-btn confirm" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <div id="view-modal" class="modal">
        <div class="modal-content modal-form">
            <h3>Travel Authority Details</h3>
            <div class="detail-list">
                <div class="detail-row">
                    <span class="detail-label">TA Number</span>
                    <span class="detail-value" id="view-ta-number">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Purpose</span>
                    <span class="detail-value" id="view-purpose">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Destination</span>
                    <span class="detail-value" id="view-destination">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Travel Date</span>
                    <span class="detail-value" id="view-travel-date">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Travel Until</span>
                    <span class="detail-value" id="view-travel-until">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">File</span>
                    <a class="link-btn" id="view-file-link" href="#" target="_blank" rel="noopener">Open file</a>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="close-view">Close</button>
            </div>
        </div>
    </div>

    <div id="update-modal" class="modal">
        <div class="modal-content modal-form">
            <h3>Update Travel Authority</h3>
            <p>Updating will overwrite the existing record.</p>
            <div class="fields">
                <div>
                    <label for="update-ta-number">TA Number <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V8h4.5L14 3.5ZM8 12h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                            </svg>
                        </span>
                        <input id="update-ta-number" type="text" placeholder="0000-00-0000" pattern="\d{4}-\d{2}-\d{4}" maxlength="12" inputmode="numeric" required>
                    </div>
                </div>
                <div>
                    <label for="update-purpose">Purpose <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M4 5h16a1 1 0 0 1 1 1v10a3 3 0 0 1-3 3H8a5 5 0 0 1-5-5V6a1 1 0 0 1 1-1Zm1 2v7a3 3 0 0 0 3 3h10a1 1 0 0 0 1-1V7H5Zm3 1h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Zm0 4h6a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2Z" />
                            </svg>
                        </span>
                        <input id="update-purpose" type="text" placeholder="Enter travel purpose" required>
                    </div>
                </div>
                <div>
                    <label for="update-destination">Destination <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z" />
                            </svg>
                        </span>
                        <input id="update-destination" type="text" placeholder="Enter destination" required>
                    </div>
                </div>
                <div class="field-row">
                    <div>
                        <label for="update-travel-date">Travel Date <span class="required">*</span></label>
                        <div class="input-wrap">
                            <span class="icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                                </svg>
                            </span>
                            <input id="update-travel-date" type="text" placeholder="Select travel date" required>
                        </div>
                    </div>
                    <div>
                        <label for="update-travel-until">Travel Until</label>
                        <div class="input-wrap">
                            <span class="icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM7 12h5v5H7z" />
                                </svg>
                            </span>
                            <input id="update-travel-until" type="text" placeholder="Select end date">
                        </div>
                    </div>
                </div>
                <div>
                    <label for="update-scan-file">Upload Scanned</label>
                    <input id="update-scan-file" type="file">
                    <p class="disclaimer">Leave empty to keep the current file.</p>
                </div>
            </div>
            <span class="status hidden" id="update-status"></span>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancel-update">Cancel</button>
                <button class="modal-btn confirm" id="confirm-update">Update</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script type="module">
        // Import Supabase
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        // Initialize Supabase
        const supabaseUrl = "https://gptfbpktebajhvwvlfkd.supabase.co";
        const supabaseKey = "sb_publishable_TVtTKkPIWDXOf1ywQTgp5w_azlcjhLb";
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Single-session enforcement for admin users
        const checkAdminSession = async () => {
            try {
                const { data: sessionData } = await supabase.auth.getSession();
                const user = sessionData?.session?.user;
                if (!user) {
                    console.log("No user session found");
                    return;
                }

                const localToken = localStorage.getItem('admin_session_token');
                if (!localToken) {
                    console.log("No local session token found");
                    return;
                }

                const { data, error } = await supabase
                    .from("profiles")
                    .select("session_token")
                    .eq("id", user.id)
                    .maybeSingle();

                if (error) {
                    console.error("Error fetching session token:", error);
                    return;
                }

                if (!data) {
                    console.log("No profile data found");
                    return;
                }

                console.log("Session check - DB token exists:", !!data.session_token, "Matches local:", data.session_token === localToken);

                // Only logout if database token exists AND doesn't match
                // If database token is null, update it (in case initial update failed)
                if (data.session_token === null) {
                    console.log("Database token is null, updating with local token");
                    const { error: updateError } = await supabase
                        .from("profiles")
                        .update({ session_token: localToken })
                        .eq("id", user.id);
                    
                    if (updateError) {
                        console.error("Failed to update session token:", updateError);
                    }
                } else if (data.session_token !== localToken) {
                    // Session token mismatch - another device logged in
                    console.log("Session token mismatch - logging out");
                    
                    // Show toast notification
                    const toastEl = document.getElementById("toast");
                    if (toastEl) {
                        toastEl.textContent = "Logged out: Another device logged into this account.";
                        toastEl.classList.add("show", "toast--warning");
                    }
                    
                    // Wait 2 seconds for user to see the toast
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    await supabase.auth.signOut();
                    localStorage.removeItem('admin_session_token');
                    window.location.href = 'index.html';
                }
            } catch (err) {
                console.error("Error in checkAdminSession:", err);
            }
        };

        // Check session every 5 seconds, start after initial delay
        setInterval(checkAdminSession, 5000);
        setTimeout(checkAdminSession, 3000); // First check after 3 seconds

        const getUserRole = async (userId) => {
            try {
                const { data, error } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", userId)
                    .maybeSingle();

                if (error) {
                    throw error;
                }

                return data?.role || "user";
            } catch (error) {
                console.error("Role lookup error:", error);
                return "user";
            }
        };

        const requireAdmin = async () => {
            const { data: sessionData, error } = await supabase.auth.getSession();
            if (error || !sessionData?.session) {
                window.location.href = "index.html";
                return;
            }

            // Note: Actual access control for admin operations (upload, delete) 
            // is enforced by Supabase RLS policies, not this client-side check.
            // This check is for UX only and should not be fully trusted for security.
        };

        // Logout functionality
        document.getElementById("logout-btn").addEventListener("click", async () => {
            try {
                // Clear admin session token
                localStorage.removeItem('admin_session_token');
                await supabase.auth.signOut();
                window.location.href = "index.html";
            } catch (error) {
                console.error("Logout error:", error);
                localStorage.removeItem('admin_session_token');
                window.location.href = "index.html";
            }
        });

        const uploadStatus = document.getElementById("upload-status");
        const taNumberInput = document.getElementById("ta-number");
        const purposeInput = document.getElementById("purpose");
        const destinationInput = document.getElementById("destination");
        const travelDateInput = document.getElementById("travel-date");
        const travelUntilInput = document.getElementById("travel-until");
        const scanFileInput = document.getElementById("scan-file");

        window.flatpickr(travelDateInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        window.flatpickr(travelUntilInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        const isValidTaNumber = (value) => /^\d{4}-\d{2}-\d{4}$/.test(value);
        const formatTaNumber = (value) => {
            const digits = value.replace(/\D/g, "").slice(0, 10);
            const part1 = digits.slice(0, 4);
            const part2 = digits.slice(4, 6);
            const part3 = digits.slice(6, 10);
            if (digits.length <= 4) return part1;
            if (digits.length <= 6) return `${part1}-${part2}`;
            return `${part1}-${part2}-${part3}`;
        };

        const formatFileLabel = (value) => {
            const base = String(value || "Download");
            const extMatch = base.match(/\.([a-z0-9]{1,5})$/i);
            const ext = extMatch ? `.${extMatch[1]}` : "";
            const compact = base.replace(/[^a-z0-9]/gi, "");
            if (compact.length <= 12) return compact || "File";
            return `${compact.slice(0, 12)}...${ext}`;
        };

        const bindTaFormatter = (input) => {
            input.addEventListener("input", () => {
                input.value = formatTaNumber(input.value);
            });
        };

        scanFileInput.addEventListener("change", () => {
            if (scanFileInput.files.length > 0) {
                uploadStatus.textContent = `Selected: ${scanFileInput.files[0].name}`;
            } else {
                uploadStatus.textContent = "Complete the required fields.";
            }
        });

        document.getElementById("upload-btn").addEventListener("click", async () => {
            const taNumber = taNumberInput.value.trim();
            const purpose = purposeInput.value.trim();
            const destination = destinationInput.value.trim();
            const travelDate = travelDateInput.value;
            let travelUntil = travelUntilInput.value;

            const file = scanFileInput.files[0];

            if (!taNumber || !purpose || !destination || !travelDate || !file) {
                uploadStatus.textContent = "Please fill in all required fields.";
                uploadStatus.classList.add("status--error");
                uploadStatus.classList.remove("status--shake");
                void uploadStatus.offsetWidth;
                uploadStatus.classList.add("status--shake");
                return;
            }

            if (!isValidTaNumber(taNumber)) {
                uploadStatus.textContent = "TA Number must be in the format 0000-00-0000.";
                uploadStatus.classList.add("status--error");
                uploadStatus.classList.remove("status--shake");
                void uploadStatus.offsetWidth;
                uploadStatus.classList.add("status--shake");
                return;
            }

            if (!travelUntil) {
                travelUntil = travelDate;
                travelUntilInput.value = travelDate;
            }

            if (travelUntil) {
                const start = new Date(`${travelDate}T00:00:00`);
                const end = new Date(`${travelUntil}T00:00:00`);
                if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
                    uploadStatus.textContent = "Please enter valid dates.";
                    uploadStatus.classList.add("status--error");
                    uploadStatus.classList.remove("status--shake");
                    void uploadStatus.offsetWidth;
                    uploadStatus.classList.add("status--shake");
                    return;
                }

                if (start > end) {
                    uploadStatus.textContent = "Travel date cannot be after travel until.";
                    uploadStatus.classList.add("status--error");
                    uploadStatus.classList.remove("status--shake");
                    void uploadStatus.offsetWidth;
                    uploadStatus.classList.add("status--shake");
                    return;
                }
            }

            try {
                uploadStatus.textContent = "Uploading...";
                uploadStatus.classList.remove("status--error");

                // Verify user is authenticated
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                if (sessionError || !sessionData?.session) {
                    throw new Error("No active session. Please log in again.");
                }

                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    throw new Error("Not authenticated");
                }

                const { data: profile, error: profileError } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", user.id)
                    .maybeSingle();

                if (profileError || profile?.role !== "admin") {
                    throw new Error("Not authorized to upload.");
                }

                const safeTa = taNumber.replace(/[^a-z0-9-_]/gi, "_");
                const safeDate = travelDate.replace(/[^0-9-]/g, "-");
                
                // Extract file extension and rename file to TA number
                const fileExtension = file.name.substring(file.name.lastIndexOf('.'));
                const newFileName = `${taNumber}${fileExtension}`;
                const filePath = `travel-authorities/${safeTa}/${safeDate}/${newFileName}`;

                const { error: uploadError } = await supabase
                    .storage
                    .from("ta-files")
                    .upload(filePath, file, { upsert: false });

                if (uploadError) {
                    throw new Error(`Storage upload failed: ${uploadError.message || "Unknown error"}`);
                }

                const { data: publicUrlData } = supabase
                    .storage
                    .from("ta-files")
                    .getPublicUrl(filePath);

                const fileUrl = publicUrlData.publicUrl;

                const { error: insertError } = await supabase
                    .from("travel_authorities")
                    .insert([
                        {
                            ta_number: taNumber,
                            purpose: purpose,
                            destination: destination,
                            travel_date: travelDate,
                            travel_until: travelUntil,
                            file_name: newFileName,
                            file_url: fileUrl
                        }
                    ]);

                if (insertError) {
                    // Check for duplicate TA number error
                    if (insertError.code === '23505' || insertError.message?.includes('duplicate key') || insertError.message?.includes('unique constraint')) {
                        throw new Error(`TA Number ${taNumber} already exists in the database.`);
                    }
                    throw new Error(`Database insert failed: ${insertError.message || "Unknown error"}`);
                }

                uploadStatus.textContent = "Upload complete.";
                console.log("File URL:", fileUrl);
            } catch (error) {
                console.error("Upload error:", error);
                const message = error && error.message ? error.message : "Please try again.";
                uploadStatus.textContent = `Upload failed: ${message}`;
                uploadStatus.classList.add("status--error");
                uploadStatus.classList.remove("status--shake");
                void uploadStatus.offsetWidth;
                uploadStatus.classList.add("status--shake");
            }
        });

        // Panel switching logic
        const switchButtons = document.querySelectorAll(".switch-btn");
        const uploadPanel = document.getElementById("upload-panel");
        const viewPanel = document.getElementById("view-panel");

        switchButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const targetPanel = btn.getAttribute("data-panel");
                
                // Update active button
                switchButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");

                // Show/hide panels
                if (targetPanel === "upload-panel") {
                    uploadPanel.classList.remove("hidden");
                    viewPanel.classList.add("hidden");
                } else {
                    uploadPanel.classList.add("hidden");
                    viewPanel.classList.remove("hidden");
                    loadTravelAuthorities(true);
                }
            });
        });

        // Table view functionality
        const viewBody = document.getElementById("view-body");
                const viewStatus = document.getElementById("view-status");
                const viewMoreBtn = document.getElementById("view-more");
        const deleteModal = document.getElementById("delete-modal");
        const viewModal = document.getElementById("view-modal");
        const updateModal = document.getElementById("update-modal");
                const cancelDeleteBtn = document.getElementById("cancel-delete");
                const closeViewBtn = document.getElementById("close-view");
        const confirmDeleteBtn = document.getElementById("confirm-delete");
        const cancelUpdateBtn = document.getElementById("cancel-update");
        const confirmUpdateBtn = document.getElementById("confirm-update");
        const viewTaNumber = document.getElementById("view-ta-number");
        const viewPurpose = document.getElementById("view-purpose");
        const viewDestination = document.getElementById("view-destination");
        const viewTravelDate = document.getElementById("view-travel-date");
        const viewTravelUntil = document.getElementById("view-travel-until");
        const viewFileLink = document.getElementById("view-file-link");
        const updateTaInput = document.getElementById("update-ta-number");
        const updatePurposeInput = document.getElementById("update-purpose");
        const updateDestinationInput = document.getElementById("update-destination");
        const updateTravelDateInput = document.getElementById("update-travel-date");
        const updateTravelUntilInput = document.getElementById("update-travel-until");
        const updateScanFileInput = document.getElementById("update-scan-file");
        const updateStatus = document.getElementById("update-status");
        const toast = document.getElementById("toast");
        bindTaFormatter(taNumberInput);
        bindTaFormatter(updateTaInput);
        const recordCache = new Map();
        const pageSize = 20;
        let viewOffset = 0;
        let viewRows = [];
        let viewHasMore = true;
        let deleteRecordData = null;
        let updateRecordData = null;
        let toastTimer = null;

        const showToast = (message) => {
            if (!toast) return;
            toast.textContent = message;
            toast.classList.add("show");
            if (toastTimer) {
                clearTimeout(toastTimer);
            }
            toastTimer = setTimeout(() => {
                toast.classList.remove("show");
            }, 2600);
        };

        window.flatpickr(updateTravelDateInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        window.flatpickr(updateTravelUntilInput, {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        const renderViewRows = (rows) => {
            if (!rows.length) {
                recordCache.clear();
                viewBody.innerHTML = "<tr><td colspan=\"8\">No records yet.</td></tr>";
                return;
            }

            recordCache.clear();
            rows.forEach((row) => {
                recordCache.set(String(row.id), row);
            });

            viewBody.innerHTML = rows.map((row) => {
                const dateText = row.travel_date ? new Date(row.travel_date).toLocaleDateString() : "-";
                const untilText = row.travel_until ? new Date(row.travel_until).toLocaleDateString() : "-";
                const fileUrl = row.file_url || "#";
                const safeName = row.file_name || "Download";
                const displayName = formatFileLabel(safeName);

                return `
                    <tr data-id="${row.id}">
                        <td>
                            <button class="view-btn icon-btn" data-id="${row.id}" aria-label="View details">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M12 5c5 0 9.3 3 11 7-1.7 4-6 7-11 7S2.7 16 1 12c1.7-4 6-7 11-7Zm0 2C8.3 7 5 9.1 3.4 12 5 14.9 8.3 17 12 17s7-2.1 8.6-5C19 9.1 15.7 7 12 7Zm0 2.2a2.8 2.8 0 1 1 0 5.6 2.8 2.8 0 0 1 0-5.6Z" />
                                </svg>
                            </button>
                        </td>
                        <td>${row.ta_number || "-"}</td>
                        <td><span class="truncate">${row.purpose || "-"}</span></td>
                        <td><span class="truncate">${row.destination || "-"}</span></td>
                        <td>${dateText}</td>
                        <td>${untilText}</td>
                        <td>
                            <a class="link-btn" href="${fileUrl}" target="_blank" rel="noopener">${displayName}</a>
                        </td>
                        <td>
                            <button class="update-btn" data-id="${row.id}">Update</button>
                            <button class="delete-btn icon-btn" data-id="${row.id}" aria-label="Delete">
                                <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                    <path d="M9 3h6l1 2h4a1 1 0 1 1 0 2h-1l-1.1 12.1a2 2 0 0 1-2 1.9H8.1a2 2 0 0 1-2-1.9L5 7H4a1 1 0 0 1 0-2h4l1-2Zm1.1 7a1 1 0 1 0-2 0v7a1 1 0 1 0 2 0v-7Zm5.9 0a1 1 0 1 0-2 0v7a1 1 0 1 0 2 0v-7Z" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join("");

            // Add delete button event listeners
            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const row = e.target.closest("tr");
                    const recordId = (row?.getAttribute("data-id") || "").trim();
                    const record = recordCache.get(recordId);
                    deleteRecordData = {
                        id: recordId,
                        file_url: record?.file_url || ""
                    };
                    deleteModal.classList.add("show");
                });
            });

            document.querySelectorAll(".update-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const row = e.target.closest("tr");
                    if (!row) return;
                    const recordId = (row.getAttribute("data-id") || "").trim();
                    const record = recordCache.get(recordId);
                    if (!recordId || !record) return;

                    updateRecordData = {
                        id: recordId,
                        file_url: record.file_url || "",
                        file_name: record.file_name || ""
                    };

                    updateTaInput.value = record.ta_number || "";
                    updatePurposeInput.value = record.purpose || "";
                    updateDestinationInput.value = record.destination || "";
                    updateTravelDateInput.value = record.travel_date || "";
                    updateTravelUntilInput.value = record.travel_until || "";
                    updateScanFileInput.value = "";
                    updateStatus.textContent = "";
                    updateStatus.classList.remove("status--error");
                    updateStatus.classList.add("hidden");

                    updateModal.classList.add("show");
                });
            });

            document.querySelectorAll(".view-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const row = e.target.closest("tr");
                    if (!row) return;
                    const recordId = (row.getAttribute("data-id") || "").trim();
                    const record = recordCache.get(recordId);
                    if (!recordId || !record) return;

                    viewTaNumber.textContent = record.ta_number || "-";
                    viewPurpose.textContent = record.purpose || "-";
                    viewDestination.textContent = record.destination || "-";
                    viewTravelDate.textContent = record.travel_date
                        ? new Date(record.travel_date).toLocaleDateString()
                        : "-";
                    viewTravelUntil.textContent = record.travel_until
                        ? new Date(record.travel_until).toLocaleDateString()
                        : "-";

                    if (record.file_url) {
                        viewFileLink.href = record.file_url;
                        viewFileLink.textContent = record.file_name || "Open file";
                    } else {
                        viewFileLink.href = "#";
                        viewFileLink.textContent = "No file";
                    }

                    viewModal.classList.add("show");
                });
            });
        };

        const updateViewFooter = () => {
            if (!viewRows.length) {
                viewStatus.textContent = "No records yet.";
            } else if (!viewHasMore) {
                viewStatus.textContent = "End of records.";
            } else {
                viewStatus.textContent = `Loaded ${viewRows.length} record${viewRows.length === 1 ? "" : "s"}.`;
            }

            if (viewMoreBtn) {
                viewMoreBtn.hidden = !viewHasMore;
            }
        };

        const loadTravelAuthorities = async (reset = false) => {
            if (reset) {
                viewOffset = 0;
                viewRows = [];
                viewHasMore = true;
                viewBody.innerHTML = "<tr><td colspan=\"8\">Loading records...</td></tr>";
            }

            if (!viewHasMore) {
                updateViewFooter();
                return;
            }

            viewStatus.textContent = "Fetching travel authorities.";
            try {
                const from = viewOffset;
                const to = viewOffset + pageSize - 1;
                const { data, error } = await supabase
                    .from("travel_authorities")
                    .select("id, ta_number, purpose, destination, travel_date, travel_until, file_name, file_url, created_at")
                    .order("created_at", { ascending: false })
                    .range(from, to);

                if (error) {
                    throw error;
                }

                const nextRows = data || [];
                viewRows = viewRows.concat(nextRows);
                viewOffset += nextRows.length;
                viewHasMore = nextRows.length === pageSize;

                renderViewRows(viewRows);
                updateViewFooter();
            } catch (error) {
                console.error("View load error:", error);
                viewBody.innerHTML = "<tr><td colspan=\"8\">Unable to load records.</td></tr>";
                viewStatus.textContent = "Failed to load travel authorities.";
            }
        };

        // Delete modal handlers
        cancelDeleteBtn.addEventListener("click", () => {
            deleteModal.classList.remove("show");
            deleteRecordData = null;
        });

        cancelUpdateBtn.addEventListener("click", () => {
            updateModal.classList.remove("show");
            updateRecordData = null;
        });

        if (viewMoreBtn) {
            viewMoreBtn.addEventListener("click", () => {
                loadTravelAuthorities(false);
            });
        }

        closeViewBtn.addEventListener("click", () => {
            viewModal.classList.remove("show");
        });

        confirmDeleteBtn.addEventListener("click", async () => {
            if (!deleteRecordData || !deleteRecordData.id) return;

            try {
                viewStatus.textContent = "Deleting record...";
                
                // Delete database record first
                const { error: deleteError } = await supabase
                    .from("travel_authorities")
                    .delete()
                    .eq("id", deleteRecordData.id);

                if (deleteError) {
                    throw deleteError;
                }

                // Extract file path from URL and delete from storage
                if (deleteRecordData.file_url) {
                    try {
                        const url = new URL(deleteRecordData.file_url);
                        const pathParts = url.pathname.split('/ta-files/');
                        if (pathParts.length > 1) {
                            const filePath = decodeURIComponent(pathParts[1]);
                            
                            const { error: storageError } = await supabase
                                .storage
                                .from("ta-files")
                                .remove([filePath]);

                            if (storageError) {
                                console.warn("Storage delete warning:", storageError);
                            }
                        }
                    } catch (urlError) {
                        console.warn("File path extraction error:", urlError);
                    }
                }

                deleteModal.classList.remove("show");
                viewStatus.textContent = "Record deleted successfully.";
                deleteRecordData = null;
                
                // Reload the table
                await loadTravelAuthorities(true);
            } catch (error) {
                console.error("Delete error:", error);
                viewStatus.textContent = `Delete failed: ${error.message || "Unknown error"}`;
                deleteModal.classList.remove("show");
                deleteRecordData = null;
            }
        });

        confirmUpdateBtn.addEventListener("click", async () => {
            if (!updateRecordData || !updateRecordData.id) return;

            const taNumber = updateTaInput.value.trim();
            const purpose = updatePurposeInput.value.trim();
            const destination = updateDestinationInput.value.trim();
            const travelDate = updateTravelDateInput.value;
            let travelUntil = updateTravelUntilInput.value;
            const file = updateScanFileInput.files[0];

            if (!taNumber || !purpose || !destination || !travelDate) {
                updateStatus.textContent = "Please fill in all required fields.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake", "hidden");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            if (!isValidTaNumber(taNumber)) {
                updateStatus.textContent = "TA Number must be in the format 0000-00-0000.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake", "hidden");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            if (!travelUntil) {
                travelUntil = travelDate;
                updateTravelUntilInput.value = travelDate;
            }

            const start = new Date(`${travelDate}T00:00:00`);
            const end = new Date(`${travelUntil}T00:00:00`);
            if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
                updateStatus.textContent = "Please enter valid dates.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake", "hidden");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            if (start > end) {
                updateStatus.textContent = "Travel date cannot be after travel until.";
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake", "hidden");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
                return;
            }

            try {
                updateStatus.textContent = "Updating...";
                updateStatus.classList.remove("status--error", "hidden");

                let fileUrl = updateRecordData.file_url || "";
                let fileName = updateRecordData.file_name || "";

                if (file) {
                    const safeTa = taNumber.replace(/[^a-z0-9-_]/gi, "_");
                    const safeDate = travelDate.replace(/[^0-9-]/g, "-");
                    
                    // Extract file extension and rename file to TA number
                    const fileExtension = file.name.substring(file.name.lastIndexOf('.'));
                    const newFileName = `${taNumber}${fileExtension}`;
                    const filePath = `travel-authorities/${safeTa}/${safeDate}/${newFileName}`;

                    const { error: uploadError } = await supabase
                        .storage
                        .from("ta-files")
                        .upload(filePath, file, { upsert: false });

                    if (uploadError) {
                        throw new Error(`Storage upload failed: ${uploadError.message || "Unknown error"}`);
                    }

                    const { data: publicUrlData } = supabase
                        .storage
                        .from("ta-files")
                        .getPublicUrl(filePath);

                    fileUrl = publicUrlData.publicUrl;
                    fileName = newFileName;
                }

                const { error: updateError } = await supabase
                    .from("travel_authorities")
                    .update({
                        ta_number: taNumber,
                        purpose: purpose,
                        destination: destination,
                        travel_date: travelDate,
                        travel_until: travelUntil,
                        file_name: fileName,
                        file_url: fileUrl
                    })
                    .eq("id", updateRecordData.id);

                if (updateError) {
                    // Check for duplicate TA number error
                    if (updateError.code === '23505' || updateError.message?.includes('duplicate key') || updateError.message?.includes('unique constraint')) {
                        throw new Error(`TA Number ${taNumber} already exists in the database.`);
                    }
                    throw new Error(`Database update failed: ${updateError.message || "Unknown error"}`);
                }

                if (file && updateRecordData.file_url) {
                    try {
                        const url = new URL(updateRecordData.file_url);
                        const pathParts = url.pathname.split('/ta-files/');
                        if (pathParts.length > 1) {
                            const oldFilePath = decodeURIComponent(pathParts[1]);

                            const { error: storageError } = await supabase
                                .storage
                                .from("ta-files")
                                .remove([oldFilePath]);

                            if (storageError) {
                                console.warn("Storage delete warning:", storageError);
                            }
                        }
                    } catch (urlError) {
                        console.warn("File path extraction error:", urlError);
                    }
                }

                updateModal.classList.remove("show");
                updateRecordData = null;
                viewStatus.textContent = "Record updated successfully.";
                showToast("Update saved.");
                await loadTravelAuthorities(true);
            } catch (error) {
                console.error("Update error:", error);
                const message = error && error.message ? error.message : "Please try again.";
                updateStatus.textContent = `Update failed: ${message}`;
                updateStatus.classList.add("status--error");
                updateStatus.classList.remove("status--shake", "hidden");
                void updateStatus.offsetWidth;
                updateStatus.classList.add("status--shake");
            }
        });

        // Close modal when clicking outside
        deleteModal.addEventListener("click", (e) => {
            if (e.target === deleteModal) {
                deleteModal.classList.remove("show");
                deleteRecordData = null;
            }
        });

        updateModal.addEventListener("click", (e) => {
            if (e.target === updateModal) {
                updateModal.classList.remove("show");
                updateRecordData = null;
            }
        });

        viewModal.addEventListener("click", (e) => {
            if (e.target === viewModal) {
                viewModal.classList.remove("show");
            }
        });

        requireAdmin();
    </script>
</body>
</html>
