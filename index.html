<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Login</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <main class="shell">
        <header>
            <div class="logo-row" aria-label="Government logos">
                <img src="CHED-Logo.png" alt="CHED logo">
                <img src="Bagong_Pilipinas_logo.png" alt="Bagong Pilipinas logo">
            </div>
            <h1>CHEDRO IV TRAVEL AUTHORITY ARCHIVE</h1>
            <p class="tagline">This portal stores scanned copies of travel authority documents filed by CHEDRO IV employees. Use a given email and password to view and download files.</p>
        </header>

        <section class="panel" id="login-panel">
            <h2>Login</h2>
            <div class="fields">
                <div>
                    <label for="email">Email <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" focusable="false">
                                <path d="M12 12.2c2.4 0 4.4-2 4.4-4.4S14.4 3.4 12 3.4 7.6 5.4 7.6 7.8s2 4.4 4.4 4.4Zm0 2.2c-3.4 0-8.2 1.7-8.2 5.1v1.1h16.4v-1.1c0-3.4-4.8-5.1-8.2-5.1Z" />
                            </svg>
                        </span>
                        <input id="email" type="email" autocomplete="email" placeholder="email">
                    </div>
                </div>
                <div>
                    <label for="password">Password <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" focusable="false">
                                <path d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2Zm-7-2a2 2 0 0 1 4 0v2h-4V7Z" />
                            </svg>
                        </span>
                        <input id="password" type="password" autocomplete="current-password" placeholder="password">
                    </div>
                </div>
            </div>
            <div class="login-actions">
                <button id="login-btn" type="button">Sign in</button>
                <span class="status status--neutral hidden" id="login-status">Enter your credentials.</span>
            </div>
        </section>

    </main>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        const supabaseUrl = "https://gptfbpktebajhvwvlfkd.supabase.co";
        const supabaseKey = "sb_publishable_TVtTKkPIWDXOf1ywQTgp5w_azlcjhLb";
        const supabase = createClient(supabaseUrl, supabaseKey);

        const loginStatus = document.getElementById("login-status");
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const loginBtn = document.getElementById("login-btn");

        const getRedirectPage = async (userId) => {
            try {
                const { data, error } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", userId)
                    .maybeSingle();

                if (error) {
                    throw error;
                }

                // Role-based redirect is for UX only. 
                // Real access control is enforced by Supabase RLS policies.
                const role = data?.role || "user";
                return role === "admin" ? "admin.html" : "dashboard.html";
            } catch (error) {
                console.error("Error fetching user role:", error);
                // Default to dashboard if role lookup fails
                return "dashboard.html";
            }
        };

        const handleLogin = async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email || !password) {
                loginStatus.textContent = "Please enter email and password.";
                loginStatus.classList.remove("status--success", "hidden");
                loginStatus.classList.add("status--error");
                loginStatus.classList.remove("status--shake");
                void loginStatus.offsetWidth;
                loginStatus.classList.add("status--shake");
                return;
            }

            loginStatus.textContent = "Signing in...";
            loginStatus.classList.remove("status--error", "status--success", "hidden");

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    throw error;
                }

                const user = data?.user;
                if (!user) {
                    throw new Error("Unable to load user session.");
                }

                loginStatus.textContent = "Signed in. Redirecting...";
                loginStatus.classList.remove("hidden");
                loginStatus.classList.add("status--success");

                const redirectPage = await getRedirectPage(user.id);
                setTimeout(() => {
                    window.location.href = redirectPage;
                }, 1000);
            } catch (error) {
                const errorMessage = error?.message || "Invalid email or password";

                loginStatus.textContent = errorMessage;
                loginStatus.classList.remove("status--success", "hidden");
                loginStatus.classList.add("status--error");
                loginStatus.classList.remove("status--shake");
                void loginStatus.offsetWidth;
                loginStatus.classList.add("status--shake");
            }
        };

        const redirectIfLoggedIn = async () => {
            const { data: sessionData } = await supabase.auth.getSession();
            const user = sessionData?.session?.user;
            if (!user) return;

            const redirectPage = await getRedirectPage(user.id);
            window.location.href = redirectPage;
        };

        loginBtn.addEventListener("click", handleLogin);

        // Trigger login when Enter key is pressed
        emailInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                handleLogin();
            }
        });

        passwordInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                handleLogin();
            }
        });

        redirectIfLoggedIn();
    </script>

</body>
</html>

