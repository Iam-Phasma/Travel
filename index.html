<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHEDRO IV TA</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="footer/footer.css">
</head>
<body>
    <main class="shell">
        <header>
            <div class="logo-row" aria-label="Government logos">
                <img src="assets/CHED-Logo.png" alt="CHED logo">
                <img src="assets/Bagong_Pilipinas_logo.png" alt="Bagong Pilipinas logo">
            </div>
            <h1>CHEDRO IV TRAVEL AUTHORITY ARCHIVE</h1>
            <p class="tagline">This portal stores scanned copies of travel authority documents filed by CHEDRO IV employees. Use the given email and password to view and download files.</p>
        </header>

        <section class="panel" id="login-panel">
            <h2>Login</h2>
            <div class="fields">
                <div>
                    <label for="email">Email <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" focusable="false">
                                <path d="M12 12.2c2.4 0 4.4-2 4.4-4.4S14.4 3.4 12 3.4 7.6 5.4 7.6 7.8s2 4.4 4.4 4.4Zm0 2.2c-3.4 0-8.2 1.7-8.2 5.1v1.1h16.4v-1.1c0-3.4-4.8-5.1-8.2-5.1Z" />
                            </svg>
                        </span>
                        <input id="email" type="email" autocomplete="email" placeholder="email">
                    </div>
                </div>
                <div>
                    <label for="password">Password <span class="required">*</span></label>
                    <div class="input-wrap">
                        <span class="icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" focusable="false">
                                <path d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2Zm-7-2a2 2 0 0 1 4 0v2h-4V7Z" />
                            </svg>
                        </span>
                        <input id="password" type="password" autocomplete="current-password" placeholder="password">
                    </div>
                </div>
            </div>
            <div class="login-actions">
                <button id="login-btn" type="button">Sign in</button>
                <span class="status status--neutral hidden" id="login-status">Enter your credentials.</span>
            </div>
        </section>

    </main>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
        import { supabaseConfig } from "./config.js";

        const supabase = createClient(supabaseConfig.url, supabaseConfig.anonKey);

        const loginStatus = document.getElementById("login-status");
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const loginBtn = document.getElementById("login-btn");

        // Database function to check if user is locked out
        const checkLockoutStatus = async (email) => {
            try {
                const { data, error } = await supabase.rpc('check_login_lockout', {
                    user_email: email
                });

                if (error) {
                    console.error("Error checking lockout:", error);
                    return { locked: false };
                }

                return data;
            } catch (err) {
                console.error("Lockout check failed:", err);
                return { locked: false };
            }
        };

        // Database function to record failed login attempt
        const recordFailedAttempt = async (email) => {
            try {
                const { data, error } = await supabase.rpc('record_failed_login', {
                    user_email: email
                });

                if (error) {
                    console.error("Error recording failed login:", error);
                    return { locked: false };
                }

                return data;
            } catch (err) {
                console.error("Failed to record attempt:", err);
                return { locked: false };
            }
        };

        // Database function to clear login attempts on successful login
        const clearLoginAttempts = async (email) => {
            try {
                await supabase.rpc('clear_failed_login', {
                    user_email: email
                });
            } catch (err) {
                console.error("Failed to clear attempts:", err);
            }
        };

        // Dynamic countdown timer for lockout
        let lockoutCountdownInterval = null;

        const stopLockoutCountdown = () => {
            if (lockoutCountdownInterval) {
                clearInterval(lockoutCountdownInterval);
                lockoutCountdownInterval = null;
            }
        };

        const startLockoutCountdown = async (email) => {
            stopLockoutCountdown(); // Clear any existing countdown

            const updateCountdown = async () => {
                const lockoutStatus = await checkLockoutStatus(email);
                
                if (!lockoutStatus.locked) {
                    // Lockout expired
                    stopLockoutCountdown();
                    loginStatus.textContent = "You can now try logging in again.";
                    loginStatus.classList.remove("status--error", "hidden");
                    loginStatus.classList.add("status--success");
                    setTimeout(() => {
                        loginStatus.classList.add("hidden");
                    }, 3000);
                    return;
                }

                // Update timer display
                const remaining = lockoutStatus.seconds_remaining || 0;
                loginStatus.textContent = `Too many failed attempts. Try again in ${remaining} second${remaining !== 1 ? 's' : ''}.`;
                loginStatus.classList.remove("status--success", "hidden");
                loginStatus.classList.add("status--error");
            };

            // Initial update
            await updateCountdown();
            
            // Update every second
            lockoutCountdownInterval = setInterval(updateCountdown, 1000);
        };

        // Clean up countdown on page unload
        window.addEventListener("beforeunload", stopLockoutCountdown);

        const getRedirectPage = async (userId) => {
            try {
                const { data, error } = await supabase
                    .from("profiles")
                    .select("role, access_enabled")
                    .eq("id", userId)
                    .maybeSingle();

                if (error) {
                    throw error;
                }

                // Check if user has access enabled
                if (data?.access_enabled === false) {
                    // User account is disabled
                    await supabase.auth.signOut();
                    throw new Error("Your account access has been disabled. Please contact an administrator to regain access.");
                }

                // Role-based redirect is for UX only. 
                // Real access control is enforced by Supabase RLS policies.
                const role = data?.role || "user";
                
                // Redirect admin and super users to admin panel, regular users to dashboard
                const page = (role === "admin" || role === "super") ? "admin/admin.html" : "dashboard/dashboard.html";
                
                return { role, page };
            } catch (error) {
                console.error("Error fetching user role:", error);
                // Re-throw error if it's about access being disabled
                if (error.message && error.message.includes("disabled")) {
                    throw error;
                }
                // Default to dashboard if role lookup fails
                return { role: "user", page: "dashboard/dashboard.html" };
            }
        };

        const handleLogin = async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email || !password) {
                loginStatus.textContent = "Please enter email and password.";
                loginStatus.classList.remove("status--success", "hidden");
                loginStatus.classList.add("status--error");
                loginStatus.classList.remove("status--shake");
                void loginStatus.offsetWidth;
                loginStatus.classList.add("status--shake");
                return;
            }

            // ✅ Check lockout status from DATABASE (cannot be bypassed)
            const lockoutStatus = await checkLockoutStatus(email);
            if (lockoutStatus.locked) {
                // Start dynamic countdown
                startLockoutCountdown(email);
                return;
            }

            loginStatus.textContent = "Signing in...";
            loginStatus.classList.remove("status--error", "status--success", "hidden");

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    throw error;
                }

                const user = data?.user;
                if (!user) {
                    throw new Error("Unable to load user session.");
                }

                // ✅ SUCCESS - Clear failed attempts from DATABASE
                await clearLoginAttempts(email);

                const { role, page } = await getRedirectPage(user.id);
                
                loginStatus.textContent = "Signed in. Redirecting...";
                loginStatus.classList.remove("hidden");
                loginStatus.classList.add("status--success");

                // For admin and super users, generate and store a session token to enforce single-session
                if (role === "admin" || role === "super") {
                    const sessionToken = crypto.randomUUID();
                    localStorage.setItem('admin_session_token', sessionToken);
                    
                    // Wait for database update to complete before redirecting
                    const { error: updateError } = await supabase
                        .from("profiles")
                        .update({ session_token: sessionToken })
                        .eq("id", user.id);
                    
                    if (updateError) {
                        console.error("Failed to update session token:", updateError);
                        loginStatus.textContent = "Warning: Session token update failed. " + updateError.message;
                    }
                    
                    // Add extra delay to ensure database propagation
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                setTimeout(() => {
                    window.location.href = page;
                }, 500);
            } catch (error) {
                const errorMessage = error?.message || "Invalid email or password";

                // ✅ FAILED - Record attempt in DATABASE (cannot be bypassed)
                const attemptResult = await recordFailedAttempt(email);

                if (attemptResult.locked) {
                    // Start dynamic countdown
                    startLockoutCountdown(email);
                } else {
                    const attemptsRemaining = attemptResult.attempts_remaining || 0;
                    // Only show attempts remaining when 5 or fewer attempts left
                    if (attemptsRemaining <= 5) {
                        loginStatus.textContent = `${errorMessage}. ${attemptsRemaining} attempt${attemptsRemaining !== 1 ? 's' : ''} remaining.`;
                    } else {
                        loginStatus.textContent = errorMessage;
                    }
                    loginStatus.classList.remove("status--success", "hidden");
                    loginStatus.classList.add("status--error");
                    loginStatus.classList.remove("status--shake");
                    void loginStatus.offsetWidth;
                    loginStatus.classList.add("status--shake");
                }
            }
        };

        const redirectIfLoggedIn = async () => {
            const { data: sessionData } = await supabase.auth.getSession();
            const user = sessionData?.session?.user;
            if (!user) return;

            const { page } = await getRedirectPage(user.id);
            window.location.href = page;
        };

        loginBtn.addEventListener("click", handleLogin);

        // Trigger login when Enter key is pressed
        emailInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                handleLogin();
            }
        });

        passwordInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                handleLogin();
            }
        });

        redirectIfLoggedIn();

        // Prevent browser back navigation after logout
        // This prevents users from navigating back to authenticated pages after logging out
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                // Page was loaded from cache (back/forward button)
                window.location.reload();
            }
        });
    </script>

    <div id="footer-container"></div>
    <script>
        fetch('footer/footer.html')
            .then(response => response.text())
            .then(data => {
                const footerHTML = data.replace(/FOOTER_ASSETS_PATH/g, 'assets');
                document.getElementById('footer-container').innerHTML = footerHTML;
            })
            .catch(error => console.error('Error loading footer:', error));
    </script>

</body>
</html>

